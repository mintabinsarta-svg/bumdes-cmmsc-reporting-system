<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan BUM Des CMMSC</title>
    <meta name="description" content="Sistem Laporan Keuangan BUM Des CMMSC - Cikahuripan Makmur Mandiri Sejahtera">
    <meta name="author" content="BUM Des CMMSC">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-transition { transition: all 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .print-hidden { display: none !important; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .sidebar-mobile { 
                position: fixed; 
                top: 0; 
                left: -100%; 
                height: 100vh; 
                z-index: 50; 
                transition: left 0.3s ease;
            }
            .sidebar-mobile.active { left: 0; }
            .overlay { 
                position: fixed; 
                top: 0; 
                left: 0; 
                right: 0; 
                bottom: 0; 
                background: rgba(0,0,0,0.5); 
                z-index: 40; 
                display: none;
            }
            .overlay.active { display: block; }
            .mobile-main { margin-left: 0 !important; }
            .mobile-grid { grid-template-columns: 1fr !important; }
            .mobile-text { font-size: 0.875rem !important; }
            .mobile-padding { padding: 1rem !important; }
            .mobile-scroll { overflow-x: auto; }
            .mobile-table { min-width: 600px; }
        }
        
        /* Touch-friendly buttons */
        .touch-button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Better form inputs for mobile */
        input, select, textarea {
            font-size: 16px; /* Prevents zoom on iOS */
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-600 to-blue-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-building text-green-600 text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">BUM Des CMMSC</h1>
                <p class="text-sm text-gray-600 mt-2">Cikahuripan Makmur Mandiri Sejahtera</p>
                <p class="text-xs text-gray-500 mt-1">Desa Cikahuripan, Kec. Klapanunggal</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan password">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="userRole" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Pilih Role</option>
                        <option value="admin">Admin (Bendahara/Direktur)</option>
                        <option value="manager_internet">Manager Unit Internet</option>
                        <option value="manager_toko">Manager Toko BUMDes</option>
                        <option value="manager_sampah">Manager Unit Sampah</option>
                        <option value="manager_pangan">Manager Ketahanan Pangan</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>Email: cmmsc.cikahuripan@gmail.com</p>
                <p>HP: 082154127777</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="overlay"></div>
        
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 no-print">
            <div class="flex items-center justify-between px-4 md:px-6 py-4">
                <div class="flex items-center space-x-3 md:space-x-4">
                    <button id="sidebarToggle" class="text-gray-600 hover:text-gray-800 touch-button">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-gray-800">BUM Des CMMSC</h1>
                        <p class="text-xs md:text-sm text-gray-600 hidden sm:block">Sistem Laporan Keuangan</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4">
                    <span id="currentUser" class="text-xs md:text-sm text-gray-600 hidden sm:block"></span>
                    <button id="logoutBtn" class="bg-red-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 touch-button">
                        <i class="fas fa-sign-out-alt md:mr-2"></i>
                        <span class="hidden md:inline">Keluar</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-gray-800 text-white w-64 min-h-screen sidebar-transition no-print md:relative sidebar-mobile">
                <nav class="p-4">
                    <ul class="space-y-2" id="sidebarMenu">
                        <!-- Menu akan diisi oleh JavaScript berdasarkan role -->
                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-4 md:p-6 mobile-main">
                <div id="content" class="fade-in">
                    <!-- Dashboard -->
                    <div id="dashboard" class="content-section">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard</h2>
                            <p class="text-gray-600">Ringkasan keuangan BUM Des CMMSC</p>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8 mobile-grid">
                            <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs md:text-sm text-gray-600">Total Aset</p>
                                        <p class="text-sm md:text-2xl font-bold text-gray-800 mobile-text" id="totalAset">Rp 0</p>
                                    </div>
                                    <div class="w-8 h-8 md:w-12 md:h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-line text-green-600 text-sm md:text-base"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs md:text-sm text-gray-600">Total Omset</p>
                                        <p class="text-sm md:text-2xl font-bold text-gray-800 mobile-text" id="totalOmset">Rp 0</p>
                                    </div>
                                    <div class="w-8 h-8 md:w-12 md:h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-money-bill-wave text-blue-600 text-sm md:text-base"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs md:text-sm text-gray-600">Laba Bersih</p>
                                        <p class="text-sm md:text-2xl font-bold text-gray-800 mobile-text" id="labaBersih">Rp 0</p>
                                    </div>
                                    <div class="w-8 h-8 md:w-12 md:h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-coins text-yellow-600 text-sm md:text-base"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-3 md:p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs md:text-sm text-gray-600">Total Kas</p>
                                        <p class="text-sm md:text-2xl font-bold text-gray-800 mobile-text" id="totalKas">Rp 0</p>
                                    </div>
                                    <div class="w-8 h-8 md:w-12 md:h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-wallet text-purple-600 text-sm md:text-base"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Kas per Akun</h3>
                                <div class="space-y-3" id="kasPerAkun">
                                    <!-- Akan diisi oleh JavaScript -->
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Pendapatan per Unit</h3>
                                <div class="space-y-3" id="pendapatanPerUnit">
                                    <!-- Akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Internet -->
                    <div id="unitInternet" class="content-section hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Unit Usaha Internet</h2>
                            <p class="text-gray-600">Kelola pendapatan dan pengeluaran unit internet</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Form Pendapatan -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pendapatan</h3>
                                <form id="pendapatanInternetForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Tujuan</label>
                                        <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                            <option value="kas_tunai">Kas Tunai Bendahara</option>
                                            <option value="kas_bjb">Kas di Bank BJB</option>
                                            <option value="kas_bri">Kas di Bank BRI</option>
                                            <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                            <option value="kas_dana">Kas di Akun DANA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Misal: Pembayaran internet bulan Januari" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="0" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Simpan Pendapatan
                                    </button>
                                </form>
                            </div>

                            <!-- Form Pengeluaran -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pengeluaran</h3>
                                <form id="pengeluaranInternetForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Sumber</label>
                                        <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                            <option value="kas_tunai">Kas Tunai Bendahara</option>
                                            <option value="kas_bjb">Kas di Bank BJB</option>
                                            <option value="kas_bri">Kas di Bank BRI</option>
                                            <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                            <option value="kas_dana">Kas di Akun DANA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Misal: Pembelian router" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                        <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="operasional">Operasional</option>
                                            <option value="aset">Pembelian Aset</option>
                                            <option value="maintenance">Maintenance</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="0" required>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                        Simpan Pengeluaran
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Tabel Transaksi -->
                        <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-4 md:p-6 border-b border-gray-200">
                                <h3 class="text-base md:text-lg font-semibold text-gray-800">Riwayat Transaksi Unit Internet</h3>
                            </div>
                            <div class="overflow-x-auto mobile-scroll">
                                <table class="w-full mobile-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akun Kas</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pengeluaran</th>
                                            <th class="px-3 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaksiInternetTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Toko BUMDes -->
                    <div id="tokoBumdes" class="content-section hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Toko BUMDes</h2>
                            <p class="text-gray-600">Kelola barang, stok, dan penjualan toko</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- Input Barang -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Barang Baru</h3>
                                <form id="barangForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Barang</label>
                                        <input type="text" name="nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Harga Beli</label>
                                        <input type="number" name="hargaBeli" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Harga Jual</label>
                                        <input type="number" name="hargaJual" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Stok Awal</label>
                                        <input type="number" name="stok" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                        Tambah Barang
                                    </button>
                                </form>
                            </div>

                            <!-- Input Penjualan -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Penjualan</h3>
                                <form id="penjualanForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Barang</label>
                                        <select name="barang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                            <option value="">Pilih Barang</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Total Harga</label>
                                        <input type="number" name="total" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Simpan Penjualan
                                    </button>
                                </form>
                            </div>

                            <!-- Update Stok -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Update Stok</h3>
                                <form id="stokForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Barang</label>
                                        <select name="barang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
                                            <option value="">Pilih Barang</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tambah Stok</label>
                                        <input type="number" name="tambahStok" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Stok Saat Ini</label>
                                        <input type="number" name="stokSaatIni" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                                    </div>
                                    <button type="submit" class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                                        Update Stok
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Tabel Barang -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Barang & Stok</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Harga Beli</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Harga Jual</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stok</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="barangTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Sampah -->
                    <div id="unitSampah" class="content-section hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Unit Pengelolaan Sampah</h2>
                            <p class="text-gray-600">Kelola pelanggan, pendapatan dan pengeluaran unit sampah</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- Input Pelanggan -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tambah Pelanggan</h3>
                                <form id="pelangganSampahForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pelanggan</label>
                                        <input type="text" name="nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                                        <textarea name="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" rows="2" required></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tarif Bulanan</label>
                                        <input type="number" name="tarif" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Tambah Pelanggan
                                    </button>
                                </form>
                            </div>

                            <!-- Input Pendapatan -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pendapatan</h3>
                                <form id="pendapatanSampahForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Pelanggan</label>
                                        <select name="pelanggan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                            <option value="">Pilih Pelanggan</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Misal: Pembayaran bulan Januari" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Simpan Pendapatan
                                    </button>
                                </form>
                            </div>

                            <!-- Input Pengeluaran -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pengeluaran</h3>
                                <form id="pengeluaranSampahForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Misal: Pembelian alat" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                        <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="operasional">Operasional</option>
                                            <option value="alat">Pembelian Alat</option>
                                            <option value="transport">Transport</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                        Simpan Pengeluaran
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Daftar Pelanggan -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Pelanggan Sampah</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Alamat</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tarif Bulanan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pelangganSampahTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Unit Ketahanan Pangan -->
                    <div id="unitPangan" class="content-section hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Unit Ketahanan Pangan</h2>
                            <p class="text-gray-600">Kelola pendapatan dan pengeluaran unit ketahanan pangan</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Form Pendapatan -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pendapatan</h3>
                                <form id="pendapatanPanganForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Misal: Penjualan hasil panen" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="0" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Simpan Pendapatan
                                    </button>
                                </form>
                            </div>

                            <!-- Form Pengeluaran -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pengeluaran</h3>
                                <form id="pengeluaranPanganForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Misal: Pembelian bibit" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                        <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="bibit">Pembelian Bibit</option>
                                            <option value="pupuk">Pupuk & Pestisida</option>
                                            <option value="alat">Alat Pertanian</option>
                                            <option value="operasional">Operasional</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="0" required>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                        Simpan Pengeluaran
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Tabel Transaksi -->
                        <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Riwayat Transaksi Unit Ketahanan Pangan</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pengeluaran</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transaksiPanganTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Panel -->
                    <div id="adminPanel" class="content-section hidden">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Panel Admin</h2>
                            <p class="text-gray-600">Kelola saldo awal, modal, dan pengaturan sistem</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Input Saldo Awal -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Saldo Awal</h3>
                                <form id="saldoAwalForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Saldo Awal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Akun</label>
                                        <select name="jenisAkun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                            <option value="">Pilih Jenis Akun</option>
                                            <option value="kas">Kas & Setara Kas</option>
                                            <option value="aset_lancar">Aset Lancar Lainnya</option>
                                            <option value="peralatan">Peralatan</option>
                                            <option value="bangunan">Bangunan</option>
                                            <option value="kendaraan">Kendaraan</option>
                                            <option value="tanah">Tanah</option>
                                            <option value="aset_tetap_lain">Aset Tetap Lainnya</option>
                                        </select>
                                    </div>
                                    <div id="kasAkunDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas</label>
                                        <select name="akun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Akun Kas</option>
                                            <option value="kas_tunai">Kas Tunai Bendahara</option>
                                            <option value="kas_bjb">Kas di Bank BJB</option>
                                            <option value="kas_bri">Kas di Bank BRI</option>
                                            <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                            <option value="kas_dana">Kas di Akun DANA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Akun/Aset</label>
                                        <input type="text" name="namaAkun" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Misal: Komputer, Gedung Kantor, Mobil Operasional" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Saldo/Nilai Awal</label>
                                        <input type="number" name="saldo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="0" required>
                                    </div>
                                    <div id="umurEkonomisDiv" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Umur Ekonomis (Tahun)</label>
                                        <select name="umurEkonomis" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">Pilih Umur</option>
                                            <option value="2">2 Tahun</option>
                                            <option value="3">3 Tahun</option>
                                            <option value="4">4 Tahun</option>
                                            <option value="5">5 Tahun</option>
                                            <option value="8">8 Tahun</option>
                                            <option value="10">10 Tahun</option>
                                            <option value="20">20 Tahun</option>
                                            <option value="0">Tidak Disusutkan (Tanah)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <textarea name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Keterangan tambahan (opsional)"></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                        Simpan Saldo Awal
                                    </button>
                                </form>
                            </div>

                            <!-- Input Modal -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Modal</h3>
                                <form id="modalForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Tujuan</label>
                                        <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                            <option value="">Pilih Akun Kas</option>
                                            <option value="kas_tunai">Kas Tunai Bendahara</option>
                                            <option value="kas_bjb">Kas di Bank BJB</option>
                                            <option value="kas_bri">Kas di Bank BRI</option>
                                            <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                            <option value="kas_dana">Kas di Akun DANA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sumber Modal</label>
                                        <select name="sumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                            <option value="">Pilih Sumber</option>
                                            <option value="penyertaan_desa">Penyertaan Modal Desa</option>
                                            <option value="sumber_lain">Sumber Lain</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                        <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Misal: Modal awal dari APBDes" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                                        <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="0" required>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        Tambah Modal
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Input Aset Tetap -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Aset Tetap</h3>
                                <form id="asetTetapForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pembelian</label>
                                        <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Sumber</label>
                                        <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                            <option value="">Pilih Akun Kas</option>
                                            <option value="kas_tunai">Kas Tunai Bendahara</option>
                                            <option value="kas_bjb">Kas di Bank BJB</option>
                                            <option value="kas_bri">Kas di Bank BRI</option>
                                            <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                            <option value="kas_dana">Kas di Akun DANA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Aset</label>
                                        <input type="text" name="nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Misal: Komputer, Meja, Kendaraan" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                        <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="elektronik">Peralatan Elektronik</option>
                                            <option value="furniture">Furniture & Perabot</option>
                                            <option value="kendaraan">Kendaraan</option>
                                            <option value="bangunan">Bangunan</option>
                                            <option value="lainnya">Lainnya</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Harga Perolehan</label>
                                        <input type="number" name="harga" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="0" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Umur Ekonomis (Tahun)</label>
                                        <select name="umurEkonomis" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                                            <option value="">Pilih Umur</option>
                                            <option value="2">2 Tahun</option>
                                            <option value="3">3 Tahun</option>
                                            <option value="4">4 Tahun</option>
                                            <option value="5">5 Tahun</option>
                                            <option value="8">8 Tahun</option>
                                            <option value="10">10 Tahun</option>
                                            <option value="20">20 Tahun</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                                        Tambah Aset Tetap
                                    </button>
                                </form>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Hitung Penyusutan</h3>
                                <form id="penyusutanForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Periode Penyusutan</label>
                                        <input type="month" name="periode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" required>
                                    </div>
                                    <button type="submit" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition duration-200">
                                        Hitung Penyusutan Bulanan
                                    </button>
                                </form>
                                
                                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                                    <h4 class="font-medium text-gray-700 mb-2">Total Penyusutan Bulan Ini</h4>
                                    <p class="text-2xl font-bold text-orange-600" id="totalPenyusutanBulan">Rp 0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Backup & Reset Data -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Backup & Reset Data</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Data</label>
                                    <button onclick="exportData()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                        <i class="fas fa-download mr-2"></i>Download Backup
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1">Simpan semua data ke file JSON</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Data</label>
                                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <p class="text-xs text-gray-500 mt-1">Restore data dari file backup</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Reset Data</label>
                                    <button onclick="resetData()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                        <i class="fas fa-trash mr-2"></i>Reset Semua
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1">Hapus semua data (hati-hati!)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Kelola Unit Usaha -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Kelola Unit Usaha</h3>
                            
                            <!-- Form Tambah Unit -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-3">Tambah Unit Usaha Baru</h4>
                                    <form id="tambahUnitForm" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Unit</label>
                                            <input type="text" name="namaUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Misal: Unit Perikanan" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Kode Unit</label>
                                            <input type="text" name="kodeUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Misal: perikanan" required>
                                            <p class="text-xs text-gray-500 mt-1">Kode harus huruf kecil tanpa spasi</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                                            <select name="iconUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                                <option value="">Pilih Icon</option>
                                                <option value="fas fa-fish"> Perikanan</option>
                                                <option value="fas fa-tractor"> Pertanian</option>
                                                <option value="fas fa-hammer"> Kerajinan</option>
                                                <option value="fas fa-truck"> Logistik</option>
                                                <option value="fas fa-utensils"> Kuliner</option>
                                                <option value="fas fa-home"> Properti</option>
                                                <option value="fas fa-car"> Transportasi</option>
                                                <option value="fas fa-leaf"> Organik</option>
                                                <option value="fas fa-tools"> Jasa</option>
                                                <option value="fas fa-shopping-bag"> Retail</option>
                                                <option value="fas fa-store"> Kios/Lapak</option>
                                                <option value="fas fa-shopping-cart"> Lapak Kaki 5</option>
                                                <option value="fas fa-futbol"> Lapangan Olahraga</option>
                                                <option value="fas fa-building"> Penyewaan</option>
                                                <option value="fas fa-warehouse"> Gudang</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                                            <textarea name="deskripsiUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Deskripsi singkat unit usaha"></textarea>
                                        </div>
                                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                            <i class="fas fa-plus mr-2"></i>Tambah Unit
                                        </button>
                                    </form>
                                </div>

                                <!-- Form Tambah User Manager -->
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-3">Tambah User Manager</h4>
                                    <form id="tambahUserForm" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                            <input type="text" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Misal: manager_perikanan" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                            <input type="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Password untuk user" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                            <select name="role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                                <option value="">Pilih Role</option>
                                                <option value="admin">Admin</option>
                                                <option value="manager">Manager Unit</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit yang Dikelola</label>
                                            <select name="unitAkses" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                                <option value="">Semua Unit (Admin)</option>
                                                <option value="internet">Unit Internet</option>
                                                <option value="toko">Toko BUMDes</option>
                                                <option value="sampah">Unit Sampah</option>
                                                <option value="pangan">Unit Pangan</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                            <i class="fas fa-user-plus mr-2"></i>Tambah User
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Daftar Unit Usaha -->
                            <div class="mb-6">
                                <h4 class="font-medium text-gray-700 mb-3">Daftar Unit Usaha</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Unit</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kode</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Icon</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Transaksi</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="unitUsahaTable" class="divide-y divide-gray-200">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Daftar Users -->
                            <div>
                                <h4 class="font-medium text-gray-700 mb-3">Daftar Users</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Akses</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTable" class="divide-y divide-gray-200">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Gambar -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Upload Gambar</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo BUMDes</label>
                                    <input type="file" id="logoBumdes" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <div id="previewLogoBumdes" class="mt-2 w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-image text-gray-400"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo Desa</label>
                                    <input type="file" id="logoDesa" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <div id="previewLogoDesa" class="mt-2 w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-image text-gray-400"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Kegiatan</label>
                                    <input type="file" id="fotoKegiatan" accept="image/*" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <div id="previewFotoKegiatan" class="mt-2 grid grid-cols-2 gap-2">
                                        <!-- Preview akan ditampilkan di sini -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Daftar Saldo Awal -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Saldo Awal & Aset</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Akun</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Akun/Aset</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akun Kas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nilai Awal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Umur (Tahun)</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Penyusutan/Bulan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akum. Penyusutan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nilai Buku</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="saldoAwalTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Daftar Aset Tetap -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Aset Tetap & Penyusutan</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Aset</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Beli</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sumber Kas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Harga Perolehan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Umur (Tahun)</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Penyusutan/Bulan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akum. Penyusutan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nilai Buku</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="asetTetapTable" class="divide-y divide-gray-200">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Kas BUMDes -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Kas BUMDes</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="kasDisplay">
                                <!-- Data kas akan diisi oleh JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Unit Sections will be inserted here -->
                    
                    <!-- Laporan -->
                    <div id="laporan" class="content-section hidden">
                        <div class="mb-6 no-print">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Laporan Keuangan</h2>
                            <p class="text-gray-600">Laporan akuntansi lengkap BUM Des CMMSC</p>
                        </div>

                        <!-- Filter dan Export -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6 no-print">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="flex items-center space-x-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Periode</label>
                                        <select id="periodeLaporan" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="bulan">Bulanan</option>
                                            <option value="tahun">Tahunan</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Bulan/Tahun</label>
                                        <input type="month" id="tanggalLaporan" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="generateLaporan" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                        <i class="fas fa-chart-bar mr-2"></i>Generate Laporan
                                    </button>
                                    <button id="exportPDF" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                                    </button>
                                    <button id="printLaporan" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                                        <i class="fas fa-print mr-2"></i>Cetak
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Laporan Content -->
                        <div id="laporanContent" class="space-y-6">
                            <!-- Header Laporan -->
                            <div class="text-center mb-8 print-only hidden">
                                <div class="flex items-center justify-center space-x-8 mb-4">
                                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-building text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-800">BUM Des CMMSC</h1>
                                        <p class="text-sm text-gray-600">Cikahuripan Makmur Mandiri Sejahtera</p>
                                        <p class="text-xs text-gray-500">Jl. Klapanunggal - Bojong, Kp. Palahlar RT. 019/008</p>
                                        <p class="text-xs text-gray-500">Desa Cikahuripan, Kec. Klapanunggal, Kab. Bogor - Jawa Barat</p>
                                    </div>
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-landmark text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                                <hr class="border-t-2 border-gray-300 mb-4">
                            </div>

                            <!-- Neraca -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">NERACA</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">ASET</h4>
                                        <div class="space-y-2" id="neracaAset">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">KEWAJIBAN & EKUITAS</h4>
                                        <div class="space-y-2" id="neracaKewajiban">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Laba Rugi -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">LAPORAN LABA RUGI</h3>
                                <div class="space-y-3" id="labaRugi">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </div>
                            </div>

                            <!-- Arus Kas -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">LAPORAN ARUS KAS</h3>
                                <div class="space-y-3" id="arusKas">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </div>
                            </div>

                            <!-- Ekuitas -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">LAPORAN PERUBAHAN EKUITAS</h3>
                                <div class="space-y-3" id="perubahanEkuitas">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </div>
                            </div>

                            <!-- Pembagian SHU -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">PEMBAGIAN SISA HASIL USAHA (SHU)</h3>
                                <div class="space-y-3" id="pembagianSHU">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 id="editModalTitle" class="text-lg font-semibold text-gray-800">Edit Data</h3>
                    <button id="closeEditModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="editForm" class="space-y-4">
                    <div id="editFormFields">
                        <!-- Form fields akan diisi oleh JavaScript -->
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Simpan Perubahan
                        </button>
                        <button type="button" id="cancelEdit" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                            <i class="fas fa-times mr-2"></i>Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let currentRole = null;
        let editingItem = null;
        let editingType = null;
        
        // Default data structure
        const defaultData = {
            users: {
                admin: { password: 'admin123', role: 'admin', unitAkses: '' },
                manager_internet: { password: 'internet123', role: 'manager_internet', unitAkses: 'internet' },
                manager_toko: { password: 'toko123', role: 'manager_toko', unitAkses: 'toko' },
                manager_sampah: { password: 'sampah123', role: 'manager_sampah', unitAkses: 'sampah' },
                manager_pangan: { password: 'pangan123', role: 'manager_pangan', unitAkses: 'pangan' }
            },
            unitUsaha: [
                { id: 'internet', nama: 'Unit Internet', icon: 'fas fa-wifi', deskripsi: 'Layanan internet dan teknologi', status: 'aktif' },
                { id: 'toko', nama: 'Toko BUMDes', icon: 'fas fa-store', deskripsi: 'Toko retail dan penjualan', status: 'aktif' },
                { id: 'sampah', nama: 'Unit Sampah', icon: 'fas fa-recycle', deskripsi: 'Pengelolaan sampah dan daur ulang', status: 'aktif' },
                { id: 'pangan', nama: 'Unit Pangan', icon: 'fas fa-seedling', deskripsi: 'Ketahanan pangan dan pertanian', status: 'aktif' }
            ],
            kas: {
                kas_tunai: 0,
                kas_bjb: 0,
                kas_bri: 0,
                kas_mandiri: 0,
                kas_dana: 0
            },
            saldoAwal: [],
            modal: [],
            transaksi: {
                internet: [],
                toko: [],
                sampah: [],
                pangan: []
            },
            barang: [],
            pelangganSampah: [],
            penjualan: [],
            asetTetap: [],
            penyusutan: []
        };

        // Load data from localStorage or use default
        let data = loadData();

        // Data persistence functions
        function saveData() {
            try {
                const dataString = JSON.stringify(data);
                const dataSize = new Blob([dataString]).size;
                
                // Check if data size is approaching localStorage limit (usually 5-10MB)
                if (dataSize > 4 * 1024 * 1024) { // 4MB warning
                    console.warn('Data mendekati batas penyimpanan browser. Pertimbangkan untuk export dan reset data lama.');
                }
                
                localStorage.setItem('bumdes_cmmsc_data', dataString);
                console.log('Data berhasil disimpan ke localStorage');
                
                // Show success indicator briefly
                showNotification('Data tersimpan otomatis', 'success');
            } catch (error) {
                console.error('Error menyimpan data:', error);
                
                if (error.name === 'QuotaExceededError') {
                    alert('Penyimpanan browser penuh! Silakan export data dan reset untuk melanjutkan.');
                } else {
                    alert('Gagal menyimpan data. Pastikan browser mendukung localStorage.');
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Auto remove after 2 seconds
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 2000);
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('bumdes_cmmsc_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Validate data structure
                    if (!validateDataStructure(parsedData)) {
                        console.warn('Struktur data tidak valid, menggunakan data default');
                        showNotification('Data tersimpan tidak valid, menggunakan data default', 'warning');
                        return JSON.parse(JSON.stringify(defaultData));
                    }
                    
                    // Merge with default data to ensure all properties exist
                    const mergedData = mergeWithDefault(parsedData, defaultData);
                    
                    // Check if backup reminder is needed (every 30 days)
                    checkBackupReminder();
                    
                    return mergedData;
                }
            } catch (error) {
                console.error('Error memuat data:', error);
                showNotification('Data tersimpan rusak, menggunakan data default', 'error');
            }
            return JSON.parse(JSON.stringify(defaultData)); // Deep copy of default data
        }

        function validateDataStructure(data) {
            const requiredKeys = ['users', 'unitUsaha', 'kas', 'saldoAwal', 'modal', 'transaksi', 'barang', 'pelangganSampah', 'penjualan', 'asetTetap', 'penyusutan'];
            
            // Check if all required keys exist
            for (const key of requiredKeys) {
                if (!(key in data)) {
                    return false;
                }
            }
            
            // Check if unitUsaha is array
            if (!Array.isArray(data.unitUsaha)) {
                return false;
            }
            
            // Check if transaksi has required sub-objects
            const requiredTransaksiKeys = ['internet', 'toko', 'sampah', 'pangan'];
            for (const key of requiredTransaksiKeys) {
                if (!(key in data.transaksi) || !Array.isArray(data.transaksi[key])) {
                    return false;
                }
            }
            
            // Check if kas has required accounts
            const requiredKasKeys = ['kas_tunai', 'kas_bjb', 'kas_bri', 'kas_mandiri', 'kas_dana'];
            for (const key of requiredKasKeys) {
                if (!(key in data.kas) || typeof data.kas[key] !== 'number') {
                    return false;
                }
            }
            
            return true;
        }

        function checkBackupReminder() {
            const lastBackupReminder = localStorage.getItem('bumdes_last_backup_reminder');
            const now = new Date().getTime();
            const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
            
            if (!lastBackupReminder || (now - parseInt(lastBackupReminder)) > thirtyDaysInMs) {
                setTimeout(() => {
                    if (confirm('Sudah 30 hari sejak pengingat backup terakhir. Apakah Anda ingin membuat backup data sekarang?')) {
                        exportData();
                    }
                    localStorage.setItem('bumdes_last_backup_reminder', now.toString());
                }, 3000); // Show after 3 seconds
            }
        }

        function mergeWithDefault(savedData, defaultData) {
            const merged = JSON.parse(JSON.stringify(defaultData));
            
            // Merge each property
            Object.keys(savedData).forEach(key => {
                if (savedData[key] !== null && savedData[key] !== undefined) {
                    if (typeof savedData[key] === 'object' && !Array.isArray(savedData[key])) {
                        merged[key] = { ...merged[key], ...savedData[key] };
                    } else {
                        merged[key] = savedData[key];
                    }
                }
            });
            
            return merged;
        }

        function resetData() {
            if (confirm('Yakin ingin menghapus SEMUA data dan kembali ke pengaturan awal? Tindakan ini tidak dapat dibatalkan!')) {
                localStorage.removeItem('bumdes_cmmsc_data');
                data = JSON.parse(JSON.stringify(defaultData));
                alert('Semua data telah dihapus. Halaman akan dimuat ulang.');
                location.reload();
            }
        }

        function exportData() {
            try {
                // Add metadata to export
                const exportData = {
                    metadata: {
                        exportDate: new Date().toISOString(),
                        version: '1.0',
                        source: 'BUMDes CMMSC System'
                    },
                    data: data
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `bumdes_cmmsc_backup_${new Date().toISOString().split('T')[0]}.json`;
                
                // Add to document and click
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Data berhasil diekspor!', 'success');
                
                // Update last backup reminder
                localStorage.setItem('bumdes_last_backup_reminder', new Date().getTime().toString());
            } catch (error) {
                console.error('Error mengekspor data:', error);
                showNotification('Gagal mengekspor data', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.name.endsWith('.json')) {
                showNotification('File harus berformat JSON', 'error');
                event.target.value = ''; // Reset input
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showNotification('File terlalu besar (maksimal 10MB)', 'error');
                event.target.value = ''; // Reset input
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedFile = JSON.parse(e.target.result);
                    let importedData;
                    
                    // Check if it's new format with metadata or old format
                    if (importedFile.metadata && importedFile.data) {
                        importedData = importedFile.data;
                        console.log('Importing data from:', importedFile.metadata.exportDate);
                    } else {
                        importedData = importedFile;
                    }
                    
                    // Validate imported data structure
                    if (!validateDataStructure(importedData)) {
                        showNotification('File backup tidak valid atau rusak', 'error');
                        event.target.value = ''; // Reset input
                        return;
                    }
                    
                    if (confirm('Yakin ingin mengganti semua data dengan data yang diimpor? Data saat ini akan hilang!')) {
                        data = mergeWithDefault(importedData, defaultData);
                        saveData();
                        showNotification('Data berhasil diimpor! Halaman akan dimuat ulang.', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Error mengimpor data:', error);
                    showNotification('File tidak valid atau rusak', 'error');
                }
                
                // Reset input regardless of outcome
                event.target.value = '';
            };
            
            reader.onerror = function() {
                showNotification('Gagal membaca file', 'error');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Generate dynamic menu based on user role and available units
        function generateMenuConfig() {
            const baseMenus = {
                admin: [
                    { id: 'dashboard', icon: 'fas fa-tachometer-alt', text: 'Dashboard' }
                ]
            };

            // Add unit menus for admin
            if (currentRole === 'admin') {
                data.unitUsaha.forEach(unit => {
                    if (unit.status === 'aktif') {
                        const unitId = getUnitSectionId(unit.id);
                        baseMenus.admin.push({
                            id: unitId,
                            icon: unit.icon,
                            text: unit.nama
                        });
                    }
                });
                
                baseMenus.admin.push(
                    { id: 'adminPanel', icon: 'fas fa-cog', text: 'Admin Panel' },
                    { id: 'laporan', icon: 'fas fa-chart-bar', text: 'Laporan' }
                );
            }

            // Generate menus for managers
            Object.keys(data.users).forEach(username => {
                const user = data.users[username];
                if (user.role.startsWith('manager_') && user.unitAkses) {
                    const unit = data.unitUsaha.find(u => u.id === user.unitAkses);
                    if (unit && unit.status === 'aktif') {
                        baseMenus[user.role] = [
                            { id: 'dashboard', icon: 'fas fa-tachometer-alt', text: 'Dashboard' },
                            { id: getUnitSectionId(unit.id), icon: unit.icon, text: unit.nama }
                        ];
                    }
                }
            });

            return baseMenus;
        }

        function getUnitSectionId(unitId) {
            const sectionMap = {
                'internet': 'unitInternet',
                'toko': 'tokoBumdes',
                'sampah': 'unitSampah',
                'pangan': 'unitPangan'
            };
            // For new units, create dynamic section ID
            return sectionMap[unitId] || `unitDynamic_${unitId}`;
        }

        // Utility Functions
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID');
        }

        function getKasLabel(kasKey) {
            const kasLabels = {
                kas_tunai: 'Kas Tunai Bendahara',
                kas_bjb: 'Kas di Bank BJB',
                kas_bri: 'Kas di Bank BRI',
                kas_mandiri: 'Kas di Bank Mandiri',
                kas_dana: 'Kas di Akun DANA'
            };
            return kasLabels[kasKey] || kasKey;
        }

        // Login System
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('userRole').value;

            if (data.users[username] && data.users[username].password === password && data.users[username].role === role) {
                currentUser = username;
                currentRole = role;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `${username} (${role})`;
                initializeApp();
            } else {
                alert('Username, password, atau role tidak valid!');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').reset();
        });

        // Create Dynamic Unit Section
        function createDynamicUnitSection(unit) {
            const sectionId = `unitDynamic_${unit.id}`;
            const contentDiv = document.getElementById('content');
            
            // Check if section already exists
            if (document.getElementById(sectionId)) return;
            
            let sectionHTML = '';
            
            // Special handling for Penyewaan Lapangan with booking system
            if (unit.id.toLowerCase().includes('lapangan')) {
                sectionHTML = createLapanganSection(unit, sectionId);
            } else {
                // Standard unit section for other units
                sectionHTML = createStandardUnitSection(unit, sectionId);
            }
            
            // Insert before laporan section
            const laporanSection = document.getElementById('laporan');
            laporanSection.insertAdjacentHTML('beforebegin', sectionHTML);
            
            // Initialize forms for this unit
            initializeDynamicUnitForms(unit.id);
        }

        function createLapanganSection(unit, sectionId) {
            return `
                <div id="${sectionId}" class="content-section hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${unit.nama}</h2>
                        <p class="text-gray-600">${unit.deskripsi || 'Kelola booking dan pendapatan penyewaan lapangan'}</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Form Booking -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Booking Lapangan</h3>
                            <form id="bookingForm_${unit.id}" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Booking</label>
                                    <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Mulai</label>
                                    <input type="time" name="jamMulai" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Selesai</label>
                                    <input type="time" name="jamSelesai" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Penyewa</label>
                                    <input type="text" name="namaPenyewa" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Nama lengkap penyewa" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">No. HP</label>
                                    <input type="tel" name="noHp" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="08xxxxxxxxxx" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Keperluan</label>
                                    <select name="keperluan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih Keperluan</option>
                                        <option value="olahraga">Olahraga</option>
                                        <option value="acara">Acara/Event</option>
                                        <option value="latihan">Latihan</option>
                                        <option value="lainnya">Lainnya</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tarif per Jam</label>
                                    <input type="number" name="tarifPerJam" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="50000" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Total Biaya</label>
                                    <input type="number" name="totalBiaya" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-calendar-plus mr-2"></i>Buat Booking
                                </button>
                            </form>
                        </div>

                        <!-- Form Pembayaran -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pembayaran</h3>
                            <form id="pembayaranForm_${unit.id}" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Booking</label>
                                    <select name="bookingId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                        <option value="">Pilih Booking</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                                    <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                        <option value="">Pilih Metode</option>
                                        <option value="kas_tunai"> Tunai</option>
                                        <option value="kas_bjb"> Transfer Bank BJB</option>
                                        <option value="kas_bri"> Transfer Bank BRI</option>
                                        <option value="kas_mandiri"> Transfer Bank Mandiri</option>
                                        <option value="kas_dana"> Transfer DANA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Bayar</label>
                                    <input type="number" name="jumlahBayar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                    <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Keterangan pembayaran">
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                    <i class="fas fa-money-bill-wave mr-2"></i>Simpan Pembayaran
                                </button>
                            </form>
                        </div>

                        <!-- Status Booking Hari Ini -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Booking Hari Ini</h3>
                            <div id="bookingHariIni_${unit.id}" class="space-y-3">
                                <!-- Data akan diisi oleh JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Tabel Booking -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Daftar Booking</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jam</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Penyewa</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. HP</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keperluan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Biaya</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingTable_${unit.id}" class="divide-y divide-gray-200">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tabel Transaksi -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Riwayat Transaksi ${unit.nama}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Metode Bayar</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transaksiTable_${unit.id}" class="divide-y divide-gray-200">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function createStandardUnitSection(unit, sectionId) {
            return `
                <div id="${sectionId}" class="content-section hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${unit.nama}</h2>
                        <p class="text-gray-600">${unit.deskripsi || 'Kelola pendapatan dan pengeluaran unit usaha'}</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Form Pendapatan -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pendapatan</h3>
                            <form id="pendapatanForm_${unit.id}" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                    <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Tujuan</label>
                                    <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                        <option value="kas_tunai">Kas Tunai Bendahara</option>
                                        <option value="kas_bjb">Kas di Bank BJB</option>
                                        <option value="kas_bri">Kas di Bank BRI</option>
                                        <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                        <option value="kas_dana">Kas di Akun DANA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                    <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Keterangan pendapatan" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                    <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="0" required>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                    Simpan Pendapatan
                                </button>
                            </form>
                        </div>

                        <!-- Form Pengeluaran -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Input Pengeluaran</h3>
                            <form id="pengeluaranForm_${unit.id}" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                    <input type="date" name="tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas Sumber</label>
                                    <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                        <option value="kas_tunai">Kas Tunai Bendahara</option>
                                        <option value="kas_bjb">Kas di Bank BJB</option>
                                        <option value="kas_bri">Kas di Bank BRI</option>
                                        <option value="kas_mandiri">Kas di Bank Mandiri</option>
                                        <option value="kas_dana">Kas di Akun DANA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                    <input type="text" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="Keterangan pengeluaran" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                    <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                                        <option value="">Pilih Kategori</option>
                                        <option value="operasional">Operasional</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="lainnya">Lainnya</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                                    <input type="number" name="jumlah" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="0" required>
                                </div>
                                <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                    Simpan Pengeluaran
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Tabel Transaksi -->
                    <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Riwayat Transaksi ${unit.nama}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Akun Kas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pendapatan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pengeluaran</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transaksiTable_${unit.id}" class="divide-y divide-gray-200">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize App
        function initializeApp() {
            buildSidebar();
            showSection('dashboard');
            updateDashboard();
            initializeForms();
        }

        // Build Sidebar
        function buildSidebar() {
            const sidebarMenu = document.getElementById('sidebarMenu');
            const menuConfig = generateMenuConfig();
            const menus = menuConfig[currentRole] || [];
            
            sidebarMenu.innerHTML = menus.map(menu => `
                <li>
                    <button onclick="showSection('${menu.id}')" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition duration-200">
                        <i class="${menu.icon}"></i>
                        <span>${menu.text}</span>
                    </button>
                </li>
            `).join('');
        }

        // Show Section
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Check if section exists, if not create it for dynamic units
            let targetSection = document.getElementById(sectionId);
            if (!targetSection && sectionId.startsWith('unitDynamic_')) {
                const unitId = sectionId.replace('unitDynamic_', '');
                const unit = data.unitUsaha.find(u => u.id === unitId);
                if (unit) {
                    createDynamicUnitSection(unit);
                    targetSection = document.getElementById(sectionId);
                }
            }
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update active menu
            document.querySelectorAll('#sidebarMenu button').forEach(btn => {
                btn.classList.remove('bg-gray-700', 'text-white');
                btn.classList.add('text-gray-300');
            });
            
            const activeBtn = document.querySelector(`#sidebarMenu button[onclick="showSection('${sectionId}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-gray-700', 'text-white');
                activeBtn.classList.remove('text-gray-300');
            }

            // Load section-specific data
            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'tokoBumdes') updateTokoData();
            if (sectionId === 'unitSampah') updateSampahData();
            if (sectionId === 'adminPanel') updateAdminData();
            if (sectionId.startsWith('unitDynamic_')) {
                const unitId = sectionId.replace('unitDynamic_', '');
                updateDynamicUnitData(unitId);
            }
        }

        // Initialize Dynamic Unit Forms
        function initializeDynamicUnitForms(unitId) {
            // Initialize booking form for lapangan units
            if (unitId.toLowerCase().includes('lapangan')) {
                const bookingForm = document.getElementById(`bookingForm_${unitId}`);
                const pembayaranForm = document.getElementById(`pembayaranForm_${unitId}`);
                
                if (bookingForm) {
                    bookingForm.addEventListener('submit', (e) => handleBookingLapangan(e, unitId));
                    
                    // Auto calculate total cost
                    const jamMulaiInput = bookingForm.querySelector('input[name="jamMulai"]');
                    const jamSelesaiInput = bookingForm.querySelector('input[name="jamSelesai"]');
                    const tarifInput = bookingForm.querySelector('input[name="tarifPerJam"]');
                    const totalInput = bookingForm.querySelector('input[name="totalBiaya"]');
                    
                    function calculateTotal() {
                        const jamMulai = jamMulaiInput.value;
                        const jamSelesai = jamSelesaiInput.value;
                        const tarif = parseInt(tarifInput.value) || 0;
                        
                        if (jamMulai && jamSelesai && tarif) {
                            const mulai = new Date(`2000-01-01 ${jamMulai}`);
                            const selesai = new Date(`2000-01-01 ${jamSelesai}`);
                            const durasi = (selesai - mulai) / (1000 * 60 * 60); // in hours
                            
                            if (durasi > 0) {
                                totalInput.value = durasi * tarif;
                            }
                        }
                    }
                    
                    jamMulaiInput.addEventListener('change', calculateTotal);
                    jamSelesaiInput.addEventListener('change', calculateTotal);
                    tarifInput.addEventListener('input', calculateTotal);
                }
                
                if (pembayaranForm) {
                    pembayaranForm.addEventListener('submit', (e) => handlePembayaranLapangan(e, unitId));
                }
            } else {
                // Initialize standard forms for other units
                const pendapatanForm = document.getElementById(`pendapatanForm_${unitId}`);
                const pengeluaranForm = document.getElementById(`pengeluaranForm_${unitId}`);
                
                if (pendapatanForm) {
                    pendapatanForm.addEventListener('submit', (e) => handlePendapatanDynamic(e, unitId));
                }
                
                if (pengeluaranForm) {
                    pengeluaranForm.addEventListener('submit', (e) => handlePengeluaranDynamic(e, unitId));
                }
            }
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const unitSection = document.getElementById(`unitDynamic_${unitId}`);
            if (unitSection) {
                unitSection.querySelectorAll('input[type="date"]').forEach(input => {
                    if (!input.value) input.value = today;
                });
            }
        }

        // Dynamic Unit Handlers
        function handleBookingLapangan(e, unitId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const booking = {
                id: Date.now(),
                unitId: unitId,
                tanggal: formData.get('tanggal'),
                jamMulai: formData.get('jamMulai'),
                jamSelesai: formData.get('jamSelesai'),
                namaPenyewa: formData.get('namaPenyewa'),
                noHp: formData.get('noHp'),
                keperluan: formData.get('keperluan'),
                tarifPerJam: parseInt(formData.get('tarifPerJam')),
                totalBiaya: parseInt(formData.get('totalBiaya')),
                status: 'booking',
                tanggalBooking: new Date().toISOString().split('T')[0]
            };
            
            // Initialize booking array if not exists
            if (!data.booking) data.booking = {};
            if (!data.booking[unitId]) data.booking[unitId] = [];
            
            data.booking[unitId].push(booking);
            saveData();
            e.target.reset();
            updateDynamicUnitData(unitId);
            alert('Booking berhasil dibuat!');
        }

        function handlePembayaranLapangan(e, unitId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const bookingId = parseInt(formData.get('bookingId'));
            const akunKas = formData.get('akunKas');
            const jumlahBayar = parseInt(formData.get('jumlahBayar'));
            
            // Find booking
            const booking = data.booking[unitId]?.find(b => b.id === bookingId);
            if (!booking) {
                alert('Booking tidak ditemukan!');
                return;
            }
            
            // Update booking status
            booking.status = 'lunas';
            booking.tanggalBayar = new Date().toISOString().split('T')[0];
            booking.metodeBayar = akunKas;
            booking.jumlahBayar = jumlahBayar;
            
            // Add to kas
            data.kas[akunKas] += jumlahBayar;
            
            // Add to transaksi
            if (!data.transaksi[unitId]) data.transaksi[unitId] = [];
            
            const transaksi = {
                id: Date.now(),
                tanggal: booking.tanggalBayar,
                keterangan: `Pembayaran sewa lapangan - ${booking.namaPenyewa}`,
                jumlah: jumlahBayar,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: unitId,
                bookingId: bookingId
            };
            
            data.transaksi[unitId].push(transaksi);
            
            saveData();
            e.target.reset();
            updateDynamicUnitData(unitId);
            updateDashboard();
            alert(`Pembayaran berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handlePendapatanDynamic(e, unitId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: unitId
            };
            
            if (!data.transaksi[unitId]) data.transaksi[unitId] = [];
            data.transaksi[unitId].push(transaksi);
            data.kas[akunKas] += jumlah;
            
            saveData();
            e.target.reset();
            updateDynamicUnitData(unitId);
            updateDashboard();
            alert(`Pendapatan berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handlePengeluaranDynamic(e, unitId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            if (data.kas[akunKas] < jumlah) {
                alert(`Saldo ${getKasLabel(akunKas)} tidak mencukupi! Saldo saat ini: ${formatRupiah(data.kas[akunKas])}`);
                return;
            }
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                kategori: formData.get('kategori'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pengeluaran',
                unit: unitId
            };
            
            if (!data.transaksi[unitId]) data.transaksi[unitId] = [];
            data.transaksi[unitId].push(transaksi);
            data.kas[akunKas] -= jumlah;
            
            saveData();
            e.target.reset();
            updateDynamicUnitData(unitId);
            updateDashboard();
            alert(`Pengeluaran berhasil disimpan dari ${getKasLabel(akunKas)}!`);
        }

        function updateDynamicUnitData(unitId) {
            const unit = data.unitUsaha.find(u => u.id === unitId);
            if (!unit) return;
            
            // Update for lapangan units
            if (unitId.toLowerCase().includes('lapangan')) {
                updateBookingData(unitId);
            }
            
            // Update transaksi table
            updateTransaksiDynamicTable(unitId);
        }

        function updateBookingData(unitId) {
            if (!data.booking || !data.booking[unitId]) return;
            
            const bookings = data.booking[unitId];
            const today = new Date().toISOString().split('T')[0];
            
            // Update booking table
            const bookingTable = document.getElementById(`bookingTable_${unitId}`);
            if (bookingTable) {
                bookingTable.innerHTML = bookings.map(b => `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(b.tanggal)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${b.jamMulai} - ${b.jamSelesai}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${b.namaPenyewa}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${b.noHp}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${b.keperluan}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(b.totalBiaya)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${b.status === 'lunas' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${b.status === 'lunas' ? 'Lunas' : 'Booking'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex space-x-2">
                                <button onclick="editBooking('${b.id}', '${unitId}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteBooking('${b.id}', '${unitId}')" class="text-red-600 hover:text-red-800 touch-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update booking hari ini
            const bookingHariIni = document.getElementById(`bookingHariIni_${unitId}`);
            if (bookingHariIni) {
                const todayBookings = bookings.filter(b => b.tanggal === today);
                bookingHariIni.innerHTML = todayBookings.length > 0 ? 
                    todayBookings.map(b => `
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-gray-800">${b.jamMulai} - ${b.jamSelesai}</p>
                                    <p class="text-sm text-gray-600">${b.namaPenyewa}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${b.status === 'lunas' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${b.status === 'lunas' ? 'Lunas' : 'Booking'}
                                </span>
                            </div>
                        </div>
                    `).join('') : 
                    '<p class="text-gray-500 text-center">Tidak ada booking hari ini</p>';
            }
            
            // Update pembayaran select
            const pembayaranSelect = document.querySelector(`#pembayaranForm_${unitId} select[name="bookingId"]`);
            if (pembayaranSelect) {
                const unpaidBookings = bookings.filter(b => b.status === 'booking');
                pembayaranSelect.innerHTML = '<option value="">Pilih Booking</option>' + 
                    unpaidBookings.map(b => `
                        <option value="${b.id}">${formatDate(b.tanggal)} - ${b.jamMulai}-${b.jamSelesai} - ${b.namaPenyewa} (${formatRupiah(b.totalBiaya)})</option>
                    `).join('');
            }
        }

        function updateTransaksiDynamicTable(unitId) {
            const transaksiTable = document.getElementById(`transaksiTable_${unitId}`);
            if (!transaksiTable || !data.transaksi[unitId]) return;
            
            const transaksi = data.transaksi[unitId];
            const unit = data.unitUsaha.find(u => u.id === unitId);
            const isLapangan = unitId.toLowerCase().includes('lapangan');
            
            if (isLapangan) {
                // Lapangan table (only pendapatan)
                transaksiTable.innerHTML = transaksi.map(t => `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(t.tanggal)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${t.keterangan}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${getKasLabel(t.akunKas || 'kas_tunai')}</td>
                        <td class="px-6 py-4 text-sm text-green-600">${formatRupiah(t.jumlah)}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex space-x-2">
                                <button onclick="editTransaksi('${t.id}', '${unitId}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTransaksi('${t.id}', '${unitId}')" class="text-red-600 hover:text-red-800 touch-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                // Standard table (pendapatan & pengeluaran)
                transaksiTable.innerHTML = transaksi.map(t => `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(t.tanggal)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${t.keterangan}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${getKasLabel(t.akunKas || 'kas_tunai')}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${t.kategori || '-'}</td>
                        <td class="px-6 py-4 text-sm text-green-600">${t.tipe === 'pendapatan' ? formatRupiah(t.jumlah) : '-'}</td>
                        <td class="px-6 py-4 text-sm text-red-600">${t.tipe === 'pengeluaran' ? formatRupiah(t.jumlah) : '-'}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex space-x-2">
                                <button onclick="editTransaksi('${t.id}', '${unitId}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteTransaksi('${t.id}', '${unitId}')" class="text-red-600 hover:text-red-800 touch-button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Booking management functions
        function editBooking(id, unitId) {
            // Implementation for editing booking
            alert('Fitur edit booking akan segera tersedia');
        }

        function deleteBooking(id, unitId) {
            if (!confirm('Yakin ingin menghapus booking ini?')) return;
            
            if (data.booking && data.booking[unitId]) {
                data.booking[unitId] = data.booking[unitId].filter(b => b.id != id);
                saveData();
                updateDynamicUnitData(unitId);
                alert('Booking berhasil dihapus!');
            }
        }

        // Initialize Forms
        function initializeForms() {
            // Unit Internet Forms
            document.getElementById('pendapatanInternetForm').addEventListener('submit', handlePendapatanInternet);
            document.getElementById('pengeluaranInternetForm').addEventListener('submit', handlePengeluaranInternet);

            // Toko Forms
            document.getElementById('barangForm').addEventListener('submit', handleTambahBarang);
            document.getElementById('penjualanForm').addEventListener('submit', handlePenjualan);
            document.getElementById('stokForm').addEventListener('submit', handleUpdateStok);

            // Unit Sampah Forms
            document.getElementById('pelangganSampahForm').addEventListener('submit', handleTambahPelangganSampah);
            document.getElementById('pendapatanSampahForm').addEventListener('submit', handlePendapatanSampah);
            document.getElementById('pengeluaranSampahForm').addEventListener('submit', handlePengeluaranSampah);

            // Unit Pangan Forms
            document.getElementById('pendapatanPanganForm').addEventListener('submit', handlePendapatanPangan);
            document.getElementById('pengeluaranPanganForm').addEventListener('submit', handlePengeluaranPangan);

            // Admin Forms
            document.getElementById('saldoAwalForm').addEventListener('submit', handleSaldoAwal);
            document.getElementById('modalForm').addEventListener('submit', handleTambahModal);
            document.getElementById('asetTetapForm').addEventListener('submit', handleTambahAsetTetap);
            document.getElementById('penyusutanForm').addEventListener('submit', handleHitungPenyusutan);
            
            // Unit Management Forms
            document.getElementById('tambahUnitForm').addEventListener('submit', handleTambahUnit);
            document.getElementById('tambahUserForm').addEventListener('submit', handleTambahUser);

            // Laporan
            document.getElementById('generateLaporan').addEventListener('click', generateLaporan);
            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            document.getElementById('printLaporan').addEventListener('click', printLaporan);

            // Form interactions
            setupSaldoAwalFormInteractions();

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });

            const thisMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('tanggalLaporan').value = thisMonth;

            // Edit modal event listeners
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
        }

        // Setup Saldo Awal Form Interactions
        function setupSaldoAwalFormInteractions() {
            const jenisAkunSelect = document.querySelector('#saldoAwalForm select[name="jenisAkun"]');
            const kasAkunDiv = document.getElementById('kasAkunDiv');
            const umurEkonomisDiv = document.getElementById('umurEkonomisDiv');
            const kasAkunSelect = document.querySelector('#saldoAwalForm select[name="akun"]');
            const umurEkonomisSelect = document.querySelector('#saldoAwalForm select[name="umurEkonomis"]');

            jenisAkunSelect.addEventListener('change', function() {
                const jenisAkun = this.value;
                
                // Show/hide kas akun dropdown
                if (jenisAkun === 'kas') {
                    kasAkunDiv.classList.remove('hidden');
                    kasAkunSelect.required = true;
                } else {
                    kasAkunDiv.classList.add('hidden');
                    kasAkunSelect.required = false;
                    kasAkunSelect.value = '';
                }

                // Show/hide umur ekonomis for aset tetap
                if (['peralatan', 'bangunan', 'kendaraan', 'aset_tetap_lain'].includes(jenisAkun)) {
                    umurEkonomisDiv.classList.remove('hidden');
                    umurEkonomisSelect.required = true;
                } else {
                    umurEkonomisDiv.classList.add('hidden');
                    umurEkonomisSelect.required = false;
                    umurEkonomisSelect.value = '';
                }
            });
        }

        // Unit Internet Handlers
        function handlePendapatanInternet(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: 'internet'
            };
            
            data.transaksi.internet.push(transaksi);
            data.kas[akunKas] += jumlah; // Update kas sesuai akun yang dipilih
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTransaksiInternetTable();
            updateDashboard();
            alert(`Pendapatan berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handlePengeluaranInternet(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            // Cek saldo kas mencukupi
            if (data.kas[akunKas] < jumlah) {
                alert(`Saldo ${getKasLabel(akunKas)} tidak mencukupi! Saldo saat ini: ${formatRupiah(data.kas[akunKas])}`);
                return;
            }
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                kategori: formData.get('kategori'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pengeluaran',
                unit: 'internet'
            };
            
            data.transaksi.internet.push(transaksi);
            data.kas[akunKas] -= jumlah; // Kurangi kas sesuai akun yang dipilih
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTransaksiInternetTable();
            updateDashboard();
            alert(`Pengeluaran berhasil disimpan dari ${getKasLabel(akunKas)}!`);
        }

        function updateTransaksiInternetTable() {
            const tbody = document.getElementById('transaksiInternetTable');
            tbody.innerHTML = data.transaksi.internet.map(t => `
                <tr>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-gray-900">${formatDate(t.tanggal)}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-gray-900">${t.keterangan}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-gray-600">${getKasLabel(t.akunKas || 'kas_tunai')}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-gray-900">${t.kategori || '-'}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-green-600">${t.tipe === 'pendapatan' ? formatRupiah(t.jumlah) : '-'}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm text-red-600">${t.tipe === 'pengeluaran' ? formatRupiah(t.jumlah) : '-'}</td>
                    <td class="px-3 md:px-6 py-4 text-xs md:text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editTransaksi('${t.id}', 'internet')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaksi('${t.id}', 'internet')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Toko BUMDes Handlers
        function handleTambahBarang(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const barang = {
                id: Date.now(),
                nama: formData.get('nama'),
                hargaBeli: parseInt(formData.get('hargaBeli')),
                hargaJual: parseInt(formData.get('hargaJual')),
                stok: parseInt(formData.get('stok'))
            };
            
            data.barang.push(barang);
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTokoData();
            alert('Barang berhasil ditambahkan!');
        }

        function handlePenjualan(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const barangId = parseInt(formData.get('barang'));
            const jumlah = parseInt(formData.get('jumlah'));
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            
            const barang = data.barang.find(b => b.id === barangId);
            if (!barang || barang.stok < jumlah) {
                alert('Stok tidak mencukupi!');
                return;
            }
            
            const penjualan = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                barangId: barangId,
                namaBarang: barang.nama,
                jumlah: jumlah,
                hargaSatuan: barang.hargaJual,
                total: jumlah * barang.hargaJual,
                akunKas: akunKas
            };
            
            data.penjualan.push(penjualan);
            barang.stok -= jumlah;
            data.kas[akunKas] += penjualan.total;
            
            // Add to transaksi toko
            data.transaksi.toko.push({
                id: Date.now(),
                tanggal: penjualan.tanggal,
                keterangan: `Penjualan ${barang.nama}`,
                jumlah: penjualan.total,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: 'toko'
            });
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTokoData();
            updateDashboard();
            alert(`Penjualan berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handleUpdateStok(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const barangId = parseInt(formData.get('barang'));
            const tambahStok = parseInt(formData.get('tambahStok'));
            
            const barang = data.barang.find(b => b.id === barangId);
            if (barang) {
                barang.stok += tambahStok;
                saveData(); // Simpan ke localStorage
                e.target.reset();
                updateTokoData();
                alert('Stok berhasil diupdate!');
            }
        }

        function updateTokoData() {
            // Update barang table
            const tbody = document.getElementById('barangTable');
            tbody.innerHTML = data.barang.map(b => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${b.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(b.hargaBeli)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(b.hargaJual)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${b.stok}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${b.stok > 10 ? 'bg-green-100 text-green-800' : b.stok > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${b.stok > 10 ? 'Tersedia' : b.stok > 0 ? 'Terbatas' : 'Habis'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="editBarang('${b.id}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteBarang('${b.id}')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Update select options
            const barangSelects = document.querySelectorAll('select[name="barang"]');
            barangSelects.forEach(select => {
                select.innerHTML = '<option value="">Pilih Barang</option>' + 
                    data.barang.map(b => `<option value="${b.id}">${b.nama} (Stok: ${b.stok})</option>`).join('');
            });

            // Update penjualan form calculation
            const penjualanForm = document.getElementById('penjualanForm');
            const barangSelect = penjualanForm.querySelector('select[name="barang"]');
            const jumlahInput = penjualanForm.querySelector('input[name="jumlah"]');
            const totalInput = penjualanForm.querySelector('input[name="total"]');

            function updateTotal() {
                const barangId = parseInt(barangSelect.value);
                const jumlah = parseInt(jumlahInput.value) || 0;
                const barang = data.barang.find(b => b.id === barangId);
                
                if (barang) {
                    totalInput.value = jumlah * barang.hargaJual;
                } else {
                    totalInput.value = 0;
                }
            }

            barangSelect.addEventListener('change', updateTotal);
            jumlahInput.addEventListener('input', updateTotal);

            // Update stok form
            const stokForm = document.getElementById('stokForm');
            const stokBarangSelect = stokForm.querySelector('select[name="barang"]');
            const stokSaatIniInput = stokForm.querySelector('input[name="stokSaatIni"]');

            stokBarangSelect.addEventListener('change', function() {
                const barangId = parseInt(this.value);
                const barang = data.barang.find(b => b.id === barangId);
                stokSaatIniInput.value = barang ? barang.stok : 0;
            });
        }

        // Unit Sampah Handlers
        function handleTambahPelangganSampah(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const pelanggan = {
                id: Date.now(),
                nama: formData.get('nama'),
                alamat: formData.get('alamat'),
                tarif: parseInt(formData.get('tarif')),
                status: 'aktif'
            };
            
            data.pelangganSampah.push(pelanggan);
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateSampahData();
            alert('Pelanggan berhasil ditambahkan!');
        }

        function handlePendapatanSampah(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                pelangganId: parseInt(formData.get('pelanggan')),
                keterangan: formData.get('keterangan'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: 'sampah'
            };
            
            data.transaksi.sampah.push(transaksi);
            data.kas[akunKas] += jumlah;
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateDashboard();
            alert(`Pendapatan berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handlePengeluaranSampah(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            // Cek saldo kas mencukupi
            if (data.kas[akunKas] < jumlah) {
                alert(`Saldo ${getKasLabel(akunKas)} tidak mencukupi! Saldo saat ini: ${formatRupiah(data.kas[akunKas])}`);
                return;
            }
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                kategori: formData.get('kategori'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pengeluaran',
                unit: 'sampah'
            };
            
            data.transaksi.sampah.push(transaksi);
            data.kas[akunKas] -= jumlah;
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateDashboard();
            alert(`Pengeluaran berhasil disimpan dari ${getKasLabel(akunKas)}!`);
        }

        function updateSampahData() {
            // Update pelanggan table
            const tbody = document.getElementById('pelangganSampahTable');
            tbody.innerHTML = data.pelangganSampah.map(p => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${p.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${p.alamat}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(p.tarif)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                            ${p.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="editPelangganSampah('${p.id}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePelangganSampah('${p.id}')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Update pelanggan select
            const pelangganSelect = document.querySelector('#pendapatanSampahForm select[name="pelanggan"]');
            pelangganSelect.innerHTML = '<option value="">Pilih Pelanggan</option>' + 
                data.pelangganSampah.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
        }

        // Unit Pangan Handlers
        function handlePendapatanPangan(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pendapatan',
                unit: 'pangan'
            };
            
            data.transaksi.pangan.push(transaksi);
            data.kas[akunKas] += jumlah;
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTransaksiPanganTable();
            updateDashboard();
            alert(`Pendapatan berhasil disimpan ke ${getKasLabel(akunKas)}!`);
        }

        function handlePengeluaranPangan(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas') || 'kas_tunai';
            const jumlah = parseInt(formData.get('jumlah'));
            
            // Cek saldo kas mencukupi
            if (data.kas[akunKas] < jumlah) {
                alert(`Saldo ${getKasLabel(akunKas)} tidak mencukupi! Saldo saat ini: ${formatRupiah(data.kas[akunKas])}`);
                return;
            }
            
            const transaksi = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                keterangan: formData.get('keterangan'),
                kategori: formData.get('kategori'),
                jumlah: jumlah,
                akunKas: akunKas,
                tipe: 'pengeluaran',
                unit: 'pangan'
            };
            
            data.transaksi.pangan.push(transaksi);
            data.kas[akunKas] -= jumlah;
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateTransaksiPanganTable();
            updateDashboard();
            alert(`Pengeluaran berhasil disimpan dari ${getKasLabel(akunKas)}!`);
        }

        function updateTransaksiPanganTable() {
            const tbody = document.getElementById('transaksiPanganTable');
            tbody.innerHTML = data.transaksi.pangan.map(t => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatDate(t.tanggal)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${t.keterangan}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${t.kategori || '-'}</td>
                    <td class="px-6 py-4 text-sm text-green-600">${t.tipe === 'pendapatan' ? formatRupiah(t.jumlah) : '-'}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${t.tipe === 'pengeluaran' ? formatRupiah(t.jumlah) : '-'}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editTransaksi('${t.id}', 'pangan')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaksi('${t.id}', 'pangan')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Admin Handlers
        function handleSaldoAwal(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const jenisAkun = formData.get('jenisAkun');
            const saldo = parseInt(formData.get('saldo'));
            
            const saldoAwalEntry = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                jenisAkun: jenisAkun,
                akun: formData.get('akun') || null,
                namaAkun: formData.get('namaAkun'),
                saldo: saldo,
                umurEkonomis: formData.get('umurEkonomis') ? parseInt(formData.get('umurEkonomis')) : null,
                keterangan: formData.get('keterangan') || '',
                penyusutanPerBulan: 0,
                akumulasiPenyusutan: 0,
                nilaiBuku: saldo
            };

            // Jika kas, update saldo kas
            if (jenisAkun === 'kas' && saldoAwalEntry.akun) {
                data.kas[saldoAwalEntry.akun] += saldo;
            }

            // Jika aset tetap yang bisa disusutkan, hitung penyusutan per bulan
            if (saldoAwalEntry.umurEkonomis && saldoAwalEntry.umurEkonomis > 0) {
                saldoAwalEntry.penyusutanPerBulan = saldo / (saldoAwalEntry.umurEkonomis * 12);
            }

            data.saldoAwal.push(saldoAwalEntry);
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateAdminData();
            updateDashboard();
            
            let message = 'Saldo awal berhasil disimpan!';
            if (jenisAkun === 'kas') {
                message += ` Kas ${getKasLabel(saldoAwalEntry.akun)} bertambah ${formatRupiah(saldo)}`;
            }
            alert(message);
        }

        function handleTambahModal(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas');
            const modal = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                akunKas: akunKas,
                sumber: formData.get('sumber'),
                keterangan: formData.get('keterangan'),
                jumlah: parseInt(formData.get('jumlah'))
            };
            
            data.modal.push(modal);
            data.kas[akunKas] += modal.jumlah;
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateAdminData();
            updateDashboard();
            alert('Modal berhasil ditambahkan ke ' + getKasLabel(akunKas) + '!');
        }

        // Aset Tetap Handlers
        function handleTambahAsetTetap(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const akunKas = formData.get('akunKas');
            const harga = parseInt(formData.get('harga'));
            
            // Cek apakah saldo kas mencukupi
            if (data.kas[akunKas] < harga) {
                alert('Saldo kas tidak mencukupi! Saldo saat ini: ' + formatRupiah(data.kas[akunKas]));
                return;
            }
            
            const aset = {
                id: Date.now(),
                tanggal: formData.get('tanggal'),
                akunKas: akunKas,
                nama: formData.get('nama'),
                kategori: formData.get('kategori'),
                harga: harga,
                umurEkonomis: parseInt(formData.get('umurEkonomis')),
                penyusutanPerBulan: harga / (parseInt(formData.get('umurEkonomis')) * 12),
                akumulasiPenyusutan: 0,
                nilaiBuku: harga
            };
            
            data.asetTetap.push(aset);
            data.kas[akunKas] -= harga; // Kurangi kas sesuai akun yang dipilih
            
            saveData(); // Simpan ke localStorage
            e.target.reset();
            updateAdminData();
            updateDashboard();
            alert('Aset tetap berhasil ditambahkan! Kas ' + getKasLabel(akunKas) + ' berkurang ' + formatRupiah(harga));
        }

        function handleHitungPenyusutan(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const periode = formData.get('periode');
            
            let totalPenyusutanBulan = 0;
            
            // Hitung penyusutan aset tetap dari pembelian
            data.asetTetap.forEach(aset => {
                const tanggalBeli = new Date(aset.tanggal);
                const periodePenyusutan = new Date(periode + '-01');
                
                // Hitung penyusutan jika aset sudah dibeli sebelum periode
                if (tanggalBeli <= periodePenyusutan) {
                    const penyusutanBulan = aset.penyusutanPerBulan;
                    
                    // Cek apakah sudah mencapai batas umur ekonomis
                    const bulanSejakBeli = (periodePenyusutan.getFullYear() - tanggalBeli.getFullYear()) * 12 + 
                                          (periodePenyusutan.getMonth() - tanggalBeli.getMonth());
                    
                    if (bulanSejakBeli < aset.umurEkonomis * 12) {
                        totalPenyusutanBulan += penyusutanBulan;
                        
                        // Update akumulasi penyusutan dan nilai buku
                        aset.akumulasiPenyusutan = Math.min(
                            aset.akumulasiPenyusutan + penyusutanBulan,
                            aset.harga
                        );
                        aset.nilaiBuku = aset.harga - aset.akumulasiPenyusutan;
                    }
                }
            });

            // Hitung penyusutan saldo awal aset tetap
            data.saldoAwal.forEach(saldo => {
                if (saldo.penyusutanPerBulan > 0) {
                    const tanggalSaldo = new Date(saldo.tanggal);
                    const periodePenyusutan = new Date(periode + '-01');
                    
                    // Hitung penyusutan jika saldo awal sudah ada sebelum periode
                    if (tanggalSaldo <= periodePenyusutan) {
                        const penyusutanBulan = saldo.penyusutanPerBulan;
                        
                        // Cek apakah sudah mencapai batas umur ekonomis
                        const bulanSejakSaldo = (periodePenyusutan.getFullYear() - tanggalSaldo.getFullYear()) * 12 + 
                                              (periodePenyusutan.getMonth() - tanggalSaldo.getMonth());
                        
                        if (bulanSejakSaldo < saldo.umurEkonomis * 12) {
                            totalPenyusutanBulan += penyusutanBulan;
                            
                            // Update akumulasi penyusutan dan nilai buku
                            saldo.akumulasiPenyusutan = Math.min(
                                saldo.akumulasiPenyusutan + penyusutanBulan,
                                saldo.saldo
                            );
                            saldo.nilaiBuku = saldo.saldo - saldo.akumulasiPenyusutan;
                        }
                    }
                }
            });
            
            // Simpan penyusutan ke transaksi
            const penyusutanEntry = {
                id: Date.now(),
                periode: periode,
                totalPenyusutan: totalPenyusutanBulan,
                tanggal: new Date().toISOString().split('T')[0]
            };
            
            data.penyusutan.push(penyusutanEntry);
            
            saveData(); // Simpan ke localStorage
            // Update display
            document.getElementById('totalPenyusutanBulan').textContent = formatRupiah(totalPenyusutanBulan);
            updateAdminData();
            
            alert(`Penyusutan untuk periode ${periode} berhasil dihitung: ${formatRupiah(totalPenyusutanBulan)}`);
        }

        // Unit Management Handlers
        function handleTambahUnit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const kodeUnit = formData.get('kodeUnit').toLowerCase().replace(/\s+/g, '');
            
            // Validasi kode unit tidak duplikat
            if (data.unitUsaha.find(u => u.id === kodeUnit)) {
                alert('Kode unit sudah ada! Gunakan kode yang berbeda.');
                return;
            }
            
            const unitBaru = {
                id: kodeUnit,
                nama: formData.get('namaUnit'),
                icon: formData.get('iconUnit'),
                deskripsi: formData.get('deskripsiUnit') || '',
                status: 'aktif'
            };
            
            // Tambah unit ke data
            data.unitUsaha.push(unitBaru);
            
            // Buat array transaksi untuk unit baru
            data.transaksi[kodeUnit] = [];
            
            saveData();
            e.target.reset();
            updateAdminData();
            buildSidebar(); // Rebuild sidebar dengan unit baru
            alert(`Unit ${unitBaru.nama} berhasil ditambahkan!`);
        }

        function handleTambahUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');
            const role = formData.get('role');
            const unitAkses = formData.get('unitAkses');
            
            // Validasi username tidak duplikat
            if (data.users[username]) {
                alert('Username sudah ada! Gunakan username yang berbeda.');
                return;
            }
            
            // Tentukan role berdasarkan unit akses
            let finalRole = role;
            if (role === 'manager' && unitAkses) {
                finalRole = `manager_${unitAkses}`;
            }
            
            const userBaru = {
                password: password,
                role: finalRole,
                unitAkses: unitAkses || ''
            };
            
            data.users[username] = userBaru;
            
            saveData();
            e.target.reset();
            updateAdminData();
            buildSidebar(); // Rebuild sidebar jika ada perubahan akses
            alert(`User ${username} berhasil ditambahkan!`);
        }

        function toggleUnitStatus(unitId) {
            const unit = data.unitUsaha.find(u => u.id === unitId);
            if (unit) {
                unit.status = unit.status === 'aktif' ? 'nonaktif' : 'aktif';
                saveData();
                updateAdminData();
                buildSidebar(); // Rebuild sidebar
                alert(`Unit ${unit.nama} berhasil ${unit.status === 'aktif' ? 'diaktifkan' : 'dinonaktifkan'}!`);
            }
        }

        function deleteUnit(unitId) {
            if (!confirm('Yakin ingin menghapus unit ini? Semua data transaksi unit akan ikut terhapus!')) return;
            
            // Hapus unit dari array
            data.unitUsaha = data.unitUsaha.filter(u => u.id !== unitId);
            
            // Hapus transaksi unit
            if (data.transaksi[unitId]) {
                delete data.transaksi[unitId];
            }
            
            // Hapus users yang terkait dengan unit
            Object.keys(data.users).forEach(username => {
                if (data.users[username].unitAkses === unitId) {
                    delete data.users[username];
                }
            });
            
            saveData();
            updateAdminData();
            buildSidebar();
            alert('Unit berhasil dihapus!');
        }

        function deleteUser(username) {
            if (!confirm(`Yakin ingin menghapus user ${username}?`)) return;
            
            delete data.users[username];
            saveData();
            updateAdminData();
            alert(`User ${username} berhasil dihapus!`);
        }

        function updateAdminData() {
            // Update unit usaha table
            const unitUsahaTable = document.getElementById('unitUsahaTable');
            unitUsahaTable.innerHTML = data.unitUsaha.map(unit => {
                const totalTransaksi = data.transaksi[unit.id] ? data.transaksi[unit.id].length : 0;
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${unit.nama}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${unit.id}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <i class="${unit.icon} mr-2"></i>${unit.icon}
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${unit.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${unit.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${totalTransaksi}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex space-x-2">
                                <button onclick="toggleUnitStatus('${unit.id}')" class="text-blue-600 hover:text-blue-800 touch-button" title="${unit.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan'}">
                                    <i class="fas fa-${unit.status === 'aktif' ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="deleteUnit('${unit.id}')" class="text-red-600 hover:text-red-800 touch-button" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update users table
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = Object.entries(data.users).map(([username, user]) => {
                const unitNama = user.unitAkses ? 
                    (data.unitUsaha.find(u => u.id === user.unitAkses)?.nama || user.unitAkses) : 
                    'Semua Unit';
                
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${username}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${user.role}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${unitNama}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                                Aktif
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex space-x-2">
                                <button onclick="deleteUser('${username}')" class="text-red-600 hover:text-red-800 touch-button" title="Hapus User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update unit akses dropdown
            const unitAksesSelect = document.querySelector('#tambahUserForm select[name="unitAkses"]');
            const currentOptions = unitAksesSelect.innerHTML;
            const newOptions = data.unitUsaha.filter(u => u.status === 'aktif').map(unit => 
                `<option value="${unit.id}">${unit.nama}</option>`
            ).join('');
            
            unitAksesSelect.innerHTML = `
                <option value="">Semua Unit (Admin)</option>
                <option value="internet">Unit Internet</option>
                <option value="toko">Toko BUMDes</option>
                <option value="sampah">Unit Sampah</option>
                <option value="pangan">Unit Pangan</option>
                ${newOptions}
            `;

            // Update saldo awal table
            const saldoAwalTbody = document.getElementById('saldoAwalTable');
            const jenisAkunLabels = {
                kas: 'Kas & Setara Kas',
                aset_lancar: 'Aset Lancar Lainnya',
                peralatan: 'Peralatan',
                bangunan: 'Bangunan',
                kendaraan: 'Kendaraan',
                tanah: 'Tanah',
                aset_tetap_lain: 'Aset Tetap Lainnya'
            };

            saldoAwalTbody.innerHTML = data.saldoAwal.map(s => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatDate(s.tanggal)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${jenisAkunLabels[s.jenisAkun] || s.jenisAkun}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${s.namaAkun}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${s.akun ? getKasLabel(s.akun) : '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(s.saldo)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${s.umurEkonomis || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${s.penyusutanPerBulan ? formatRupiah(s.penyusutanPerBulan) : '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(s.akumulasiPenyusutan)}</td>
                    <td class="px-6 py-4 text-sm font-medium ${s.nilaiBuku > 0 ? 'text-green-600' : 'text-gray-500'}">${formatRupiah(s.nilaiBuku)}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editSaldoAwal('${s.id}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSaldoAwal('${s.id}')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Update aset tetap table
            const tbody = document.getElementById('asetTetapTable');
            tbody.innerHTML = data.asetTetap.map(a => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${a.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${a.kategori}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatDate(a.tanggal)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${getKasLabel(a.akunKas || 'kas_tunai')}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(a.harga)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${a.umurEkonomis}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(a.penyusutanPerBulan)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${formatRupiah(a.akumulasiPenyusutan)}</td>
                    <td class="px-6 py-4 text-sm font-medium ${a.nilaiBuku > 0 ? 'text-green-600' : 'text-gray-500'}">${formatRupiah(a.nilaiBuku)}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editAsetTetap('${a.id}')" class="text-blue-600 hover:text-blue-800 touch-button">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAsetTetap('${a.id}')" class="text-red-600 hover:text-red-800 touch-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Update kas display
            const kasDisplay = document.getElementById('kasDisplay');
            const kasLabels = {
                kas_tunai: 'Kas Tunai Bendahara',
                kas_bjb: 'Kas di Bank BJB',
                kas_bri: 'Kas di Bank BRI',
                kas_mandiri: 'Kas di Bank Mandiri',
                kas_dana: 'Kas di Akun DANA'
            };

            kasDisplay.innerHTML = Object.entries(data.kas).map(([key, value]) => `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">${kasLabels[key]}</p>
                    <p class="text-lg font-semibold text-gray-800">${formatRupiah(value)}</p>
                </div>
            `).join('');
        }

        // Dashboard Update
        function updateDashboard() {
            // Calculate totals including dynamic units
            let allPendapatan = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.toko,
                ...data.transaksi.sampah.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pendapatan')
            ];

            let allPengeluaran = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran')
            ];

            // Add dynamic units transactions
            data.unitUsaha.forEach(unit => {
                if (!['internet', 'toko', 'sampah', 'pangan'].includes(unit.id) && data.transaksi[unit.id]) {
                    allPendapatan.push(...data.transaksi[unit.id].filter(t => t.tipe === 'pendapatan'));
                    allPengeluaran.push(...data.transaksi[unit.id].filter(t => t.tipe === 'pengeluaran'));
                }
            });

            const totalPendapatan = allPendapatan.reduce((sum, t) => sum + t.jumlah, 0);
            const totalPengeluaran = allPengeluaran.reduce((sum, t) => sum + t.jumlah, 0);

            // Tambahkan beban penyusutan ke pengeluaran
            const totalPenyusutan = data.penyusutan.reduce((sum, p) => sum + p.totalPenyusutan, 0);
            const totalPenyusutanSaldoAwal = data.saldoAwal.reduce((sum, s) => sum + s.akumulasiPenyusutan, 0);
            const totalPengeluaranDenganPenyusutan = totalPengeluaran + totalPenyusutan;

            const totalModal = data.modal.reduce((sum, m) => sum + m.jumlah, 0);
            const totalKas = Object.values(data.kas).reduce((sum, k) => sum + k, 0);
            const totalInventory = data.barang.reduce((sum, b) => sum + (b.stok * b.hargaBeli), 0);
            const totalAsetTetap = data.asetTetap.reduce((sum, a) => sum + a.nilaiBuku, 0);
            const totalSaldoAwalAset = data.saldoAwal.filter(s => s.jenisAkun !== 'kas').reduce((sum, s) => sum + s.nilaiBuku, 0);
            const totalAset = totalKas + totalInventory + totalAsetTetap + totalSaldoAwalAset;
            const labaBersih = totalPendapatan - totalPengeluaranDenganPenyusutan;

            // Update dashboard cards
            document.getElementById('totalAset').textContent = formatRupiah(totalAset);
            document.getElementById('totalOmset').textContent = formatRupiah(totalPendapatan);
            document.getElementById('labaBersih').textContent = formatRupiah(labaBersih);
            document.getElementById('totalKas').textContent = formatRupiah(totalKas);

            // Update kas per akun
            const kasPerAkun = document.getElementById('kasPerAkun');
            const kasLabels = {
                kas_tunai: 'Kas Tunai',
                kas_bjb: 'Bank BJB',
                kas_bri: 'Bank BRI',
                kas_mandiri: 'Bank Mandiri',
                kas_dana: 'DANA'
            };

            kasPerAkun.innerHTML = Object.entries(data.kas).map(([key, value]) => `
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">${kasLabels[key]}</span>
                    <span class="font-medium">${formatRupiah(value)}</span>
                </div>
            `).join('');

            // Update pendapatan per unit
            const pendapatanPerUnit = document.getElementById('pendapatanPerUnit');
            const unitPendapatan = {
                'Unit Internet': data.transaksi.internet.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0),
                'Toko BUMDes': data.transaksi.toko.reduce((sum, t) => sum + t.jumlah, 0),
                'Unit Sampah': data.transaksi.sampah.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0),
                'Unit Pangan': data.transaksi.pangan.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0)
            };

            // Add dynamic units to pendapatan calculation
            data.unitUsaha.forEach(unit => {
                if (!['internet', 'toko', 'sampah', 'pangan'].includes(unit.id) && data.transaksi[unit.id]) {
                    const pendapatan = data.transaksi[unit.id].filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0);
                    unitPendapatan[unit.nama] = pendapatan;
                }
            });

            pendapatanPerUnit.innerHTML = Object.entries(unitPendapatan).map(([unit, pendapatan]) => `
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">${unit}</span>
                    <span class="font-medium">${formatRupiah(pendapatan)}</span>
                </div>
            `).join('');
        }

        // Laporan Functions
        function generateLaporan() {
            const periode = document.getElementById('periodeLaporan').value;
            const tanggal = document.getElementById('tanggalLaporan').value;
            
            // Generate Neraca
            generateNeraca();
            
            // Generate Laba Rugi
            generateLabaRugi();
            
            // Generate Arus Kas
            generateArusKas();
            
            // Generate Perubahan Ekuitas
            generatePerubahanEkuitas();
            
            // Generate Pembagian SHU
            generatePembagianSHU();
            
            alert('Laporan berhasil digenerate!');
        }

        function generateNeraca() {
            const totalKas = Object.values(data.kas).reduce((sum, k) => sum + k, 0);
            const totalInventory = data.barang.reduce((sum, b) => sum + (b.stok * b.hargaBeli), 0);
            const totalAsetTetapBruto = data.asetTetap.reduce((sum, a) => sum + a.harga, 0);
            const totalAkumulasiPenyusutan = data.asetTetap.reduce((sum, a) => sum + a.akumulasiPenyusutan, 0);
            const totalAsetTetapNeto = totalAsetTetapBruto - totalAkumulasiPenyusutan;
            const totalAset = totalKas + totalInventory + totalAsetTetapNeto;
            const totalModal = data.modal.reduce((sum, m) => sum + m.jumlah, 0);
            
            const totalPendapatan = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.toko,
                ...data.transaksi.sampah.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pendapatan')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalPengeluaran = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalPenyusutan = data.penyusutan.reduce((sum, p) => sum + p.totalPenyusutan, 0);
            const labaDitahan = totalPendapatan - totalPengeluaran - totalPenyusutan;
            const totalEkuitas = totalModal + labaDitahan;

            document.getElementById('neracaAset').innerHTML = `
                <div class="flex justify-between">
                    <span>Kas dan Setara Kas</span>
                    <span>${formatRupiah(totalKas)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Persediaan</span>
                    <span>${formatRupiah(totalInventory)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Aset Tetap (Bruto)</span>
                    <span>${formatRupiah(totalAsetTetapBruto)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Akumulasi Penyusutan</span>
                    <span>(${formatRupiah(totalAkumulasiPenyusutan)})</span>
                </div>
                <div class="flex justify-between ml-4 font-medium">
                    <span>Aset Tetap (Neto)</span>
                    <span>${formatRupiah(totalAsetTetapNeto)}</span>
                </div>
                <div class="flex justify-between font-bold border-t pt-2">
                    <span>TOTAL ASET</span>
                    <span>${formatRupiah(totalAset)}</span>
                </div>
            `;

            document.getElementById('neracaKewajiban').innerHTML = `
                <div class="flex justify-between">
                    <span>Modal Disetor</span>
                    <span>${formatRupiah(totalModal)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Laba Ditahan</span>
                    <span>${formatRupiah(labaDitahan)}</span>
                </div>
                <div class="flex justify-between font-bold border-t pt-2">
                    <span>TOTAL EKUITAS</span>
                    <span>${formatRupiah(totalEkuitas)}</span>
                </div>
            `;
        }

        function generateLabaRugi() {
            const pendapatanInternet = data.transaksi.internet.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0);
            const pendapatanToko = data.transaksi.toko.reduce((sum, t) => sum + t.jumlah, 0);
            const pendapatanSampah = data.transaksi.sampah.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0);
            const pendapatanPangan = data.transaksi.pangan.filter(t => t.tipe === 'pendapatan').reduce((sum, t) => sum + t.jumlah, 0);
            const totalPendapatan = pendapatanInternet + pendapatanToko + pendapatanSampah + pendapatanPangan;

            const pengeluaranInternet = data.transaksi.internet.filter(t => t.tipe === 'pengeluaran').reduce((sum, t) => sum + t.jumlah, 0);
            const pengeluaranSampah = data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran').reduce((sum, t) => sum + t.jumlah, 0);
            const pengeluaranPangan = data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran').reduce((sum, t) => sum + t.jumlah, 0);
            const bebanPenyusutan = data.penyusutan.reduce((sum, p) => sum + p.totalPenyusutan, 0);
            const totalPengeluaran = pengeluaranInternet + pengeluaranSampah + pengeluaranPangan + bebanPenyusutan;

            const labaBersih = totalPendapatan - totalPengeluaran;

            document.getElementById('labaRugi').innerHTML = `
                <div class="font-semibold text-gray-700 mb-2">PENDAPATAN</div>
                <div class="flex justify-between ml-4">
                    <span>Pendapatan Unit Internet</span>
                    <span>${formatRupiah(pendapatanInternet)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Pendapatan Toko BUMDes</span>
                    <span>${formatRupiah(pendapatanToko)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Pendapatan Unit Sampah</span>
                    <span>${formatRupiah(pendapatanSampah)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Pendapatan Unit Pangan</span>
                    <span>${formatRupiah(pendapatanPangan)}</span>
                </div>
                <div class="flex justify-between font-semibold border-t pt-2">
                    <span>TOTAL PENDAPATAN</span>
                    <span>${formatRupiah(totalPendapatan)}</span>
                </div>
                
                <div class="font-semibold text-gray-700 mb-2 mt-4">BEBAN</div>
                <div class="flex justify-between ml-4">
                    <span>Beban Unit Internet</span>
                    <span>${formatRupiah(pengeluaranInternet)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Beban Unit Sampah</span>
                    <span>${formatRupiah(pengeluaranSampah)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Beban Unit Pangan</span>
                    <span>${formatRupiah(pengeluaranPangan)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Beban Penyusutan</span>
                    <span>${formatRupiah(bebanPenyusutan)}</span>
                </div>
                <div class="flex justify-between font-semibold border-t pt-2">
                    <span>TOTAL BEBAN</span>
                    <span>${formatRupiah(totalPengeluaran)}</span>
                </div>
                
                <div class="flex justify-between font-bold text-lg border-t-2 border-gray-400 pt-2 mt-2">
                    <span>LABA BERSIH</span>
                    <span class="${labaBersih >= 0 ? 'text-green-600' : 'text-red-600'}">${formatRupiah(labaBersih)}</span>
                </div>
            `;
        }

        function generateArusKas() {
            const totalPendapatan = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.toko,
                ...data.transaksi.sampah.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pendapatan')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalPengeluaran = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalModal = data.modal.reduce((sum, m) => sum + m.jumlah, 0);
            const kasAkhir = Object.values(data.kas).reduce((sum, k) => sum + k, 0);

            document.getElementById('arusKas').innerHTML = `
                <div class="font-semibold text-gray-700 mb-2">ARUS KAS DARI AKTIVITAS OPERASI</div>
                <div class="flex justify-between ml-4">
                    <span>Penerimaan dari pelanggan</span>
                    <span>${formatRupiah(totalPendapatan)}</span>
                </div>
                <div class="flex justify-between ml-4">
                    <span>Pembayaran untuk operasional</span>
                    <span>(${formatRupiah(totalPengeluaran)})</span>
                </div>
                <div class="flex justify-between font-semibold border-t pt-2">
                    <span>Kas Bersih dari Aktivitas Operasi</span>
                    <span>${formatRupiah(totalPendapatan - totalPengeluaran)}</span>
                </div>
                
                <div class="font-semibold text-gray-700 mb-2 mt-4">ARUS KAS DARI AKTIVITAS PENDANAAN</div>
                <div class="flex justify-between ml-4">
                    <span>Penerimaan modal</span>
                    <span>${formatRupiah(totalModal)}</span>
                </div>
                <div class="flex justify-between font-semibold border-t pt-2">
                    <span>Kas Bersih dari Aktivitas Pendanaan</span>
                    <span>${formatRupiah(totalModal)}</span>
                </div>
                
                <div class="flex justify-between font-bold text-lg border-t-2 border-gray-400 pt-2 mt-2">
                    <span>KENAIKAN BERSIH KAS</span>
                    <span>${formatRupiah(kasAkhir)}</span>
                </div>
            `;
        }

        function generatePerubahanEkuitas() {
            const totalModal = data.modal.reduce((sum, m) => sum + m.jumlah, 0);
            const totalPendapatan = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.toko,
                ...data.transaksi.sampah.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pendapatan')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalPengeluaran = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const labaBersih = totalPendapatan - totalPengeluaran;
            const totalEkuitas = totalModal + labaBersih;

            document.getElementById('perubahanEkuitas').innerHTML = `
                <div class="flex justify-between">
                    <span>Saldo Awal Ekuitas</span>
                    <span>${formatRupiah(0)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Penambahan Modal</span>
                    <span>${formatRupiah(totalModal)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Laba Bersih Tahun Berjalan</span>
                    <span>${formatRupiah(labaBersih)}</span>
                </div>
                <div class="flex justify-between font-bold border-t pt-2">
                    <span>SALDO AKHIR EKUITAS</span>
                    <span>${formatRupiah(totalEkuitas)}</span>
                </div>
            `;
        }

        function generatePembagianSHU() {
            const totalPendapatan = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.toko,
                ...data.transaksi.sampah.filter(t => t.tipe === 'pendapatan'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pendapatan')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const totalPengeluaran = [
                ...data.transaksi.internet.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.sampah.filter(t => t.tipe === 'pengeluaran'),
                ...data.transaksi.pangan.filter(t => t.tipe === 'pengeluaran')
            ].reduce((sum, t) => sum + t.jumlah, 0);

            const shu = totalPendapatan - totalPengeluaran;
            
            const penambahanModal = shu * 0.35;
            const pendapatanAsliDesa = shu * 0.30;
            const insentifPengurus = shu * 0.20;
            const peningkatanKapasitas = shu * 0.10;
            const csr = shu * 0.05;

            document.getElementById('pembagianSHU').innerHTML = `
                <div class="flex justify-between font-semibold">
                    <span>Total SHU (Sisa Hasil Usaha)</span>
                    <span>${formatRupiah(shu)}</span>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between">
                        <span>Penambahan Modal (35%)</span>
                        <span>${formatRupiah(penambahanModal)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Pendapatan Asli Desa (30%)</span>
                        <span>${formatRupiah(pendapatanAsliDesa)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Insentif Pengurus (20%)</span>
                        <span>${formatRupiah(insentifPengurus)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Peningkatan Kapasitas Pengurus (10%)</span>
                        <span>${formatRupiah(peningkatanKapasitas)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>CSR (5%)</span>
                        <span>${formatRupiah(csr)}</span>
                    </div>
                </div>
                <div class="flex justify-between font-bold border-t pt-2 mt-2">
                    <span>TOTAL PEMBAGIAN</span>
                    <span>${formatRupiah(penambahanModal + pendapatanAsliDesa + insentifPengurus + peningkatanKapasitas + csr)}</span>
                </div>
            `;
        }

        function exportToPDF() {
            // This is a demo implementation
            alert('Fitur export PDF akan menggunakan library jsPDF untuk mengkonversi laporan ke format PDF');
        }

        function printLaporan() {
            window.print();
        }

        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            // Check if mobile
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('w-64');
                sidebar.classList.toggle('w-16');
            }
        });

        // Close sidebar when clicking overlay
        document.getElementById('mobileOverlay').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });

        // Edit and Delete Functions
        function editTransaksi(id, unit) {
            const transaksi = data.transaksi[unit].find(t => t.id == id);
            if (!transaksi) return;

            editingItem = transaksi;
            editingType = `transaksi_${unit}`;

            document.getElementById('editModalTitle').textContent = `Edit Transaksi ${unit.charAt(0).toUpperCase() + unit.slice(1)}`;
            
            let formFields = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" name="tanggal" value="${transaksi.tanggal}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                    <input type="text" name="keterangan" value="${transaksi.keterangan}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Akun Kas</label>
                    <select name="akunKas" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="kas_tunai" ${transaksi.akunKas === 'kas_tunai' ? 'selected' : ''}>Kas Tunai Bendahara</option>
                        <option value="kas_bjb" ${transaksi.akunKas === 'kas_bjb' ? 'selected' : ''}>Kas di Bank BJB</option>
                        <option value="kas_bri" ${transaksi.akunKas === 'kas_bri' ? 'selected' : ''}>Kas di Bank BRI</option>
                        <option value="kas_mandiri" ${transaksi.akunKas === 'kas_mandiri' ? 'selected' : ''}>Kas di Bank Mandiri</option>
                        <option value="kas_dana" ${transaksi.akunKas === 'kas_dana' ? 'selected' : ''}>Kas di Akun DANA</option>
                    </select>
                </div>`;

            if (transaksi.kategori) {
                formFields += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <input type="text" name="kategori" value="${transaksi.kategori}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>`;
            }

            formFields += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                    <input type="number" name="jumlah" value="${transaksi.jumlah}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>`;

            document.getElementById('editFormFields').innerHTML = formFields;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editBarang(id) {
            const barang = data.barang.find(b => b.id == id);
            if (!barang) return;

            editingItem = barang;
            editingType = 'barang';

            document.getElementById('editModalTitle').textContent = 'Edit Barang';
            document.getElementById('editFormFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Barang</label>
                    <input type="text" name="nama" value="${barang.nama}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga Beli</label>
                    <input type="number" name="hargaBeli" value="${barang.hargaBeli}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga Jual</label>
                    <input type="number" name="hargaJual" value="${barang.hargaJual}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stok</label>
                    <input type="number" name="stok" value="${barang.stok}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
            `;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editPelangganSampah(id) {
            const pelanggan = data.pelangganSampah.find(p => p.id == id);
            if (!pelanggan) return;

            editingItem = pelanggan;
            editingType = 'pelangganSampah';

            document.getElementById('editModalTitle').textContent = 'Edit Pelanggan Sampah';
            document.getElementById('editFormFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pelanggan</label>
                    <input type="text" name="nama" value="${pelanggan.nama}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                    <textarea name="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2" required>${pelanggan.alamat}</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tarif Bulanan</label>
                    <input type="number" name="tarif" value="${pelanggan.tarif}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="aktif" ${pelanggan.status === 'aktif' ? 'selected' : ''}>Aktif</option>
                        <option value="nonaktif" ${pelanggan.status === 'nonaktif' ? 'selected' : ''}>Non-aktif</option>
                    </select>
                </div>
            `;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editSaldoAwal(id) {
            const saldo = data.saldoAwal.find(s => s.id == id);
            if (!saldo) return;

            editingItem = saldo;
            editingType = 'saldoAwal';

            document.getElementById('editModalTitle').textContent = 'Edit Saldo Awal';
            document.getElementById('editFormFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" name="tanggal" value="${saldo.tanggal}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Akun/Aset</label>
                    <input type="text" name="namaAkun" value="${saldo.namaAkun}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Saldo/Nilai</label>
                    <input type="number" name="saldo" value="${saldo.saldo}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                    <textarea name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2">${saldo.keterangan || ''}</textarea>
                </div>
            `;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function editAsetTetap(id) {
            const aset = data.asetTetap.find(a => a.id == id);
            if (!aset) return;

            editingItem = aset;
            editingType = 'asetTetap';

            document.getElementById('editModalTitle').textContent = 'Edit Aset Tetap';
            document.getElementById('editFormFields').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pembelian</label>
                    <input type="date" name="tanggal" value="${aset.tanggal}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Aset</label>
                    <input type="text" name="nama" value="${aset.nama}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <select name="kategori" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="elektronik" ${aset.kategori === 'elektronik' ? 'selected' : ''}>Peralatan Elektronik</option>
                        <option value="furniture" ${aset.kategori === 'furniture' ? 'selected' : ''}>Furniture & Perabot</option>
                        <option value="kendaraan" ${aset.kategori === 'kendaraan' ? 'selected' : ''}>Kendaraan</option>
                        <option value="bangunan" ${aset.kategori === 'bangunan' ? 'selected' : ''}>Bangunan</option>
                        <option value="lainnya" ${aset.kategori === 'lainnya' ? 'selected' : ''}>Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga Perolehan</label>
                    <input type="number" name="harga" value="${aset.harga}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Umur Ekonomis (Tahun)</label>
                    <select name="umurEkonomis" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        <option value="2" ${aset.umurEkonomis === 2 ? 'selected' : ''}>2 Tahun</option>
                        <option value="3" ${aset.umurEkonomis === 3 ? 'selected' : ''}>3 Tahun</option>
                        <option value="4" ${aset.umurEkonomis === 4 ? 'selected' : ''}>4 Tahun</option>
                        <option value="5" ${aset.umurEkonomis === 5 ? 'selected' : ''}>5 Tahun</option>
                        <option value="8" ${aset.umurEkonomis === 8 ? 'selected' : ''}>8 Tahun</option>
                        <option value="10" ${aset.umurEkonomis === 10 ? 'selected' : ''}>10 Tahun</option>
                        <option value="20" ${aset.umurEkonomis === 20 ? 'selected' : ''}>20 Tahun</option>
                    </select>
                </div>
            `;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function handleEditSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (editingType.startsWith('transaksi_')) {
                const unit = editingType.split('_')[1];
                const oldAkunKas = editingItem.akunKas || 'kas_tunai';
                const newAkunKas = formData.get('akunKas');
                const oldJumlah = editingItem.jumlah;
                const newJumlah = parseInt(formData.get('jumlah'));

                // Revert old transaction effect on kas
                if (editingItem.tipe === 'pendapatan') {
                    data.kas[oldAkunKas] -= oldJumlah;
                } else {
                    data.kas[oldAkunKas] += oldJumlah;
                }

                // Apply new transaction effect on kas
                if (editingItem.tipe === 'pendapatan') {
                    data.kas[newAkunKas] += newJumlah;
                } else {
                    // Check if new kas account has sufficient balance
                    if (data.kas[newAkunKas] < newJumlah) {
                        alert(`Saldo ${getKasLabel(newAkunKas)} tidak mencukupi!`);
                        // Revert the old transaction
                        if (editingItem.tipe === 'pendapatan') {
                            data.kas[oldAkunKas] += oldJumlah;
                        } else {
                            data.kas[oldAkunKas] -= oldJumlah;
                        }
                        return;
                    }
                    data.kas[newAkunKas] -= newJumlah;
                }

                // Update transaction data
                editingItem.tanggal = formData.get('tanggal');
                editingItem.keterangan = formData.get('keterangan');
                editingItem.akunKas = newAkunKas;
                editingItem.jumlah = newJumlah;
                if (formData.get('kategori')) {
                    editingItem.kategori = formData.get('kategori');
                }

                if (unit === 'internet') updateTransaksiInternetTable();
                if (unit === 'pangan') updateTransaksiPanganTable();
            }
            else if (editingType === 'barang') {
                editingItem.nama = formData.get('nama');
                editingItem.hargaBeli = parseInt(formData.get('hargaBeli'));
                editingItem.hargaJual = parseInt(formData.get('hargaJual'));
                editingItem.stok = parseInt(formData.get('stok'));
                updateTokoData();
            }
            else if (editingType === 'pelangganSampah') {
                editingItem.nama = formData.get('nama');
                editingItem.alamat = formData.get('alamat');
                editingItem.tarif = parseInt(formData.get('tarif'));
                editingItem.status = formData.get('status');
                updateSampahData();
            }
            else if (editingType === 'saldoAwal') {
                const oldSaldo = editingItem.saldo;
                const newSaldo = parseInt(formData.get('saldo'));
                
                // Update kas if it's a kas account
                if (editingItem.jenisAkun === 'kas' && editingItem.akun) {
                    data.kas[editingItem.akun] = data.kas[editingItem.akun] - oldSaldo + newSaldo;
                }

                editingItem.tanggal = formData.get('tanggal');
                editingItem.namaAkun = formData.get('namaAkun');
                editingItem.saldo = newSaldo;
                editingItem.keterangan = formData.get('keterangan');
                editingItem.nilaiBuku = newSaldo - editingItem.akumulasiPenyusutan;
                
                // Recalculate depreciation if applicable
                if (editingItem.umurEkonomis && editingItem.umurEkonomis > 0) {
                    editingItem.penyusutanPerBulan = newSaldo / (editingItem.umurEkonomis * 12);
                }
                
                updateAdminData();
            }
            else if (editingType === 'asetTetap') {
                const oldHarga = editingItem.harga;
                const newHarga = parseInt(formData.get('harga'));
                const oldAkunKas = editingItem.akunKas;
                const newAkunKas = formData.get('akunKas') || oldAkunKas;

                // Revert old purchase effect
                data.kas[oldAkunKas] += oldHarga;

                // Check if new kas account has sufficient balance
                if (data.kas[newAkunKas] < newHarga) {
                    alert(`Saldo ${getKasLabel(newAkunKas)} tidak mencukupi!`);
                    data.kas[oldAkunKas] -= oldHarga; // Revert
                    return;
                }

                // Apply new purchase effect
                data.kas[newAkunKas] -= newHarga;

                editingItem.tanggal = formData.get('tanggal');
                editingItem.nama = formData.get('nama');
                editingItem.kategori = formData.get('kategori');
                editingItem.harga = newHarga;
                editingItem.umurEkonomis = parseInt(formData.get('umurEkonomis'));
                editingItem.akunKas = newAkunKas;
                editingItem.penyusutanPerBulan = newHarga / (editingItem.umurEkonomis * 12);
                editingItem.nilaiBuku = newHarga - editingItem.akumulasiPenyusutan;
                
                updateAdminData();
            }

            saveData(); // Simpan semua perubahan ke localStorage
            closeEditModal();
            updateDashboard();
            alert('Data berhasil diupdate!');
        }

        function deleteTransaksi(id, unit) {
            if (!confirm('Yakin ingin menghapus transaksi ini?')) return;

            const transaksi = data.transaksi[unit].find(t => t.id == id);
            if (!transaksi) return;

            // Revert kas effect
            const akunKas = transaksi.akunKas || 'kas_tunai';
            if (transaksi.tipe === 'pendapatan') {
                data.kas[akunKas] -= transaksi.jumlah;
            } else {
                data.kas[akunKas] += transaksi.jumlah;
            }

            // Remove from array
            data.transaksi[unit] = data.transaksi[unit].filter(t => t.id != id);

            saveData(); // Simpan perubahan ke localStorage
            if (unit === 'internet') updateTransaksiInternetTable();
            if (unit === 'pangan') updateTransaksiPanganTable();
            updateDashboard();
            alert('Transaksi berhasil dihapus!');
        }

        function deleteBarang(id) {
            if (!confirm('Yakin ingin menghapus barang ini?')) return;
            data.barang = data.barang.filter(b => b.id != id);
            saveData(); // Simpan perubahan ke localStorage
            updateTokoData();
            alert('Barang berhasil dihapus!');
        }

        function deletePelangganSampah(id) {
            if (!confirm('Yakin ingin menghapus pelanggan ini?')) return;
            data.pelangganSampah = data.pelangganSampah.filter(p => p.id != id);
            saveData(); // Simpan perubahan ke localStorage
            updateSampahData();
            alert('Pelanggan berhasil dihapus!');
        }

        function deleteSaldoAwal(id) {
            if (!confirm('Yakin ingin menghapus saldo awal ini?')) return;
            
            const saldo = data.saldoAwal.find(s => s.id == id);
            if (saldo && saldo.jenisAkun === 'kas' && saldo.akun) {
                data.kas[saldo.akun] -= saldo.saldo;
            }
            
            data.saldoAwal = data.saldoAwal.filter(s => s.id != id);
            saveData(); // Simpan perubahan ke localStorage
            updateAdminData();
            updateDashboard();
            alert('Saldo awal berhasil dihapus!');
        }

        function deleteAsetTetap(id) {
            if (!confirm('Yakin ingin menghapus aset tetap ini?')) return;
            
            const aset = data.asetTetap.find(a => a.id == id);
            if (aset) {
                data.kas[aset.akunKas] += aset.harga; // Return the money
            }
            
            data.asetTetap = data.asetTetap.filter(a => a.id != id);
            saveData(); // Simpan perubahan ke localStorage
            updateAdminData();
            updateDashboard();
            alert('Aset tetap berhasil dihapus!');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingItem = null;
            editingType = null;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970e186667c79de3',t:'MTc1NTQ4NTMzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
